# Bot A 和 Bot B 管理员统一配置指南

## 概述

Bot A 和 Bot B 现在支持通过 `.env` 文件统一配置管理员列表。

## 配置方式

### 方法一：通过环境变量（推荐）

在项目根目录的 `.env` 文件中添加一行：

```env
ADMIN_IDS=7974525763,5433982810
```

**格式说明：**
- 多个管理员 ID 用逗号分隔
- 不要有空格（或确保空格被正确处理）
- 示例：`ADMIN_IDS=123456789,987654321,555666777`

### 方法二：代码中硬编码（不推荐）

如果 `.env` 文件中没有设置 `ADMIN_IDS`，两个 Bot 会使用代码中的默认管理员列表。

## 当前配置

两个 Bot 默认使用相同的管理员列表：
- `7974525763`
- `5433982810`

## Bot A 的特殊说明

Bot A 使用数据库管理管理员，支持动态添加/删除：

1. **初始化**：Bot A 启动时，会将 `.env` 中的 `ADMIN_IDS` 或默认管理员添加到数据库
2. **动态管理**：管理员可以通过 `/admin` 命令添加/删除其他管理员
3. **持久化**：所有管理员信息存储在 `botA/wushipay.db` 数据库的 `admins` 表中

### Bot A 管理命令

- `/admin` - 打开管理面板
- `/addadmin <user_id>` - 添加管理员（需要是现有管理员）

### Bot A 数据库管理

管理员列表存储在 `botA/wushipay.db` 数据库的 `admins` 表中，可以通过以下方式管理：

```python
# 查看所有管理员
from database.admin_repository import AdminRepository
admins = AdminRepository.get_all_admins()
print(admins)
```

## Bot B 的说明

Bot B 目前使用静态配置：

1. **读取来源**：优先从 `.env` 文件的 `ADMIN_IDS` 读取，如果没有则使用代码默认值
2. **运行时**：管理员列表在 Bot 启动时确定，运行时不可更改（除非重启 Bot）

### Bot B 管理员功能

- 可以使用快捷指令（`w01`, `w02`, `w03`, `w04`, `w08`）
- 可以查看详细价格信息
- 可以设置管理员加价

## 统一配置示例

### 步骤 1：编辑 `.env` 文件

在项目根目录（`/home/ubuntu/wushizhifu/.env`）添加或修改：

```env
BOT_TOKEN=your_bot_a_token_here
BOT_TOKEN_B=your_bot_b_token_here
ADMIN_IDS=7974525763,5433982810
```

### 步骤 2：重启服务

```bash
# 重启 Bot A
sudo systemctl restart wushizhifu-bot.service

# 重启 Bot B
sudo systemctl restart otc-bot.service
```

### 步骤 3：验证配置

#### 验证 Bot A

1. 发送 `/admin` 命令给 Bot A
2. 如果能打开管理面板，说明您是管理员

#### 验证 Bot B

1. 发送 `/start` 命令给 Bot B
2. 如果欢迎消息中包含管理员专用指令说明，说明您是管理员
3. 尝试发送 `w01` 命令，如果能获取详细价格，说明您是管理员

## 添加新管理员

### Bot A（推荐方式）

使用 `/addadmin <user_id>` 命令添加，会同步到数据库。

### Bot B

1. 获取新管理员的 Telegram User ID
2. 编辑 `.env` 文件，在 `ADMIN_IDS` 中添加新的 ID：
   ```env
   ADMIN_IDS=7974525763,5433982810,新的管理员ID
   ```
3. 重启 Bot B：
   ```bash
   sudo systemctl restart otc-bot.service
   ```

### 统一添加（两个 Bot 同时生效）

1. 编辑 `.env` 文件，添加新管理员 ID
2. 同时重启两个 Bot：
   ```bash
   sudo systemctl restart wushizhifu-bot.service
   sudo systemctl restart otc-bot.service
   ```

## 注意事项

1. **User ID 获取方式**：
   - 让用户先与 Bot 对话（发送任意消息）
   - 查看日志：`sudo journalctl -u wushizhifu-bot.service -f`
   - 或者使用第三方 Bot（如 @userinfobot）获取

2. **配置生效**：
   - 修改 `.env` 后需要重启 Bot 才能生效
   - Bot A 数据库中的管理员不受 `.env` 变更影响（除非重新初始化数据库）

3. **优先级**：
   - Bot A：数据库管理员 > `.env` 中的 `ADMIN_IDS`（用于初始化）
   - Bot B：`.env` 中的 `ADMIN_IDS` > 代码默认值

4. **安全性**：
   - 确保 `.env` 文件权限正确：`chmod 600 .env`
   - 不要将 `.env` 文件提交到 Git 仓库

## 故障排查

### 问题：修改 `.env` 后管理员权限未生效

**解决方案：**
1. 确认 `.env` 文件格式正确（逗号分隔，无多余空格）
2. 确认已重启 Bot 服务
3. 查看日志确认配置读取正确：
   ```bash
   sudo journalctl -u wushizhifu-bot.service -n 50 | grep -i admin
   sudo journalctl -u otc-bot.service -n 50 | grep -i admin
   ```

### 问题：Bot A 和 Bot B 管理员列表不一致

**解决方案：**
1. 确认两个 Bot 都从同一个 `.env` 文件读取配置
2. Bot A 可能使用了数据库中的管理员（通过 `/addadmin` 添加的）
3. 检查 Bot A 数据库：
   ```bash
   sqlite3 /home/ubuntu/wushizhifu/botA/wushipay.db "SELECT user_id FROM admins WHERE status='active';"
   ```

## 最佳实践

1. **统一管理**：使用 `.env` 文件统一配置初始管理员
2. **Bot A 动态管理**：日常添加/删除管理员使用 Bot A 的 `/addadmin` 命令
3. **定期同步**：如果需要在 Bot B 中添加管理员，更新 `.env` 并重启 Bot B
4. **文档记录**：记录所有管理员及其职责

