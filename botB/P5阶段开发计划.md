# Bot B P5 阶段开发计划

## 📋 阶段概述

P5 阶段主要包括三个高级功能模块：
1. **数据可视化** - 以图表形式展示统计数据
2. **API 接口** - 提供 RESTful API 支持第三方集成
3. **多币种支持** - 支持其他稳定币和法币

---

## 🎨 功能一：数据可视化

### 1.1 功能描述

以图表形式展示交易统计数据，提升数据展示效果，帮助管理员和用户更直观地理解交易趋势和分布。

### 1.2 技术方案

**图表库选择**：`matplotlib`（轻量级，易集成）

**实现方式**：
- 生成图片后通过 Telegram Bot API 发送
- 支持 PNG 格式，自动压缩优化
- 图表样式：专业、简洁、易读

### 1.3 功能清单

#### 1.3.1 交易趋势图（折线图）

**功能点**：
- ✅ 显示最近 7 天的交易量趋势
- ✅ 显示最近 30 天的交易量趋势
- ✅ 支持群组级别和全局级别
- ✅ 显示 CNY 和 USDT 双轴

**入口**：
- 群组统计菜单 → 「📈 趋势图表」
- 命令：`/chart_trend [7|30]`

#### 1.3.2 交易量统计（柱状图）

**功能点**：
- ✅ 按日期显示交易量（柱状图）
- ✅ 按用户显示交易量排行（Top 10）
- ✅ 支持群组和全局统计

**入口**：
- 统计菜单 → 「📊 交易量图表」

#### 1.3.3 用户分布（饼图）

**功能点**：
- ✅ 活跃用户分布（按交易次数）
- ✅ 交易金额分布（按金额区间）
- ✅ 群组活跃度分布

**入口**：
- 统计菜单 → 「👥 用户分布」

#### 1.3.4 价格趋势图

**功能点**：
- ✅ 显示最近 24 小时价格变化
- ✅ 显示最近 7 天价格趋势
- ✅ 标注最高价、最低价、平均价

**入口**：
- 价格查询 → 「📈 价格趋势」

---

## 🔌 功能二：API 接口

### 2.1 功能描述

提供 RESTful API 接口，支持第三方系统集成，实现自动化结算、数据查询等功能。

### 2.2 技术方案

**框架选择**：`FastAPI`（高性能、自动文档生成）

**架构设计**：
```
API Server (FastAPI)
    ↓
Bot B Database
    ↓
Services Layer
```

### 2.3 API 设计

#### 2.3.1 认证机制

**API Key 认证**：
- 每个用户/管理员可以生成 API Key
- API Key 存储在数据库中
- 支持 API Key 启用/禁用
- 支持设置 API Key 权限范围

#### 2.3.2 核心接口

**1. 查询汇率**
```
GET /api/v1/price
Headers: X-API-Key: <api_key>

Response:
{
  "base_price": 7.2345,
  "final_price": 7.2845,
  "markup": 0.05,
  "source": "binance_p2p",
  "timestamp": "2025-01-XX 12:00:00"
}
```

**2. 计算结算**
```
POST /api/v1/settlement
Headers: X-API-Key: <api_key>

Request:
{
  "cny_amount": 20000,
  "group_id": -1001234567890  # Optional
}

Response:
{
  "transaction_id": "tx_123456",
  "cny_amount": 20000,
  "usdt_amount": 2746.58,
  "exchange_rate": 7.2845,
  "markup": 0.05,
  "usdt_address": "T..."
}
```

**3. 查询账单**
```
GET /api/v1/transactions
Headers: X-API-Key: <api_key>

Query Parameters:
- group_id: Optional[int]
- user_id: Optional[int]
- start_date: Optional[str]
- end_date: Optional[str]
- limit: int = 50
- offset: int = 0

Response:
{
  "total": 100,
  "transactions": [...]
}
```

**4. 查询统计**
```
GET /api/v1/statistics
Headers: X-API-Key: <api_key>

Query Parameters:
- group_id: Optional[int]
- period: str = "today"  # today, week, month

Response:
{
  "period": "today",
  "count": 15,
  "total_cny": 298500.00,
  "total_usdt": 41023.45,
  "avg_cny": 19900.00
}
```

#### 2.3.3 API 管理

**1. API Key 管理**
- 生成 API Key
- 查看 API Key 列表
- 禁用/启用 API Key
- 删除 API Key
- 查看 API Key 使用统计

**2. 请求频率限制**
- 每 API Key 每分钟最多 60 次请求
- 每 API Key 每天最多 10000 次请求

**3. API 文档**
- 自动生成 Swagger 文档
- 提供 Postman Collection

---

## 💱 功能三：多币种支持

### 3.1 功能描述

扩展系统支持多种稳定币（USDC、DAI）和法币（USD、EUR），满足不同用户的需求。

### 3.2 支持的币种

**稳定币**：
- USDT（已支持）
- USDC（新增）
- DAI（新增）

**法币**：
- CNY（已支持）
- USD（新增）
- EUR（新增）

### 3.3 技术实现

#### 3.3.1 数据库扩展

**扩展 `transactions` 表**：
```sql
ALTER TABLE transactions ADD COLUMN base_currency TEXT DEFAULT 'CNY';
ALTER TABLE transactions ADD COLUMN quote_currency TEXT DEFAULT 'USDT';
```

**新增 `currency_settings` 表**：
```sql
CREATE TABLE currency_settings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    group_id BIGINT,
    base_currency TEXT DEFAULT 'CNY',
    quote_currency TEXT DEFAULT 'USDT',
    is_active INTEGER DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.3.2 价格服务扩展

**扩展价格获取函数**：
- `get_price(base_currency, quote_currency)` - 通用价格获取
- `get_usdc_cny_price()` - USDC/CNY
- `get_dai_cny_price()` - DAI/CNY
- `get_usdt_usd_price()` - USDT/USD（通过 USDT/CNY 和 USD/CNY 换算）

**API 数据源**：
- CoinGecko：支持多币种对
- Binance P2P：支持多法币对

#### 3.3.3 结算逻辑扩展

**扩展结算服务**：
- 支持指定基础货币和报价货币
- 自动获取对应币种对的价格
- 计算转换后的数量

**示例**：
```python
# CNY → USDT（原有）
settle(20000, base='CNY', quote='USDT')

# CNY → USDC（新增）
settle(20000, base='CNY', quote='USDC')

# USD → USDT（新增）
settle(1000, base='USD', quote='USDT')
```

#### 3.3.4 UI 扩展

**币种选择界面**：
- 群组设置中增加币种选择
- 结算时支持选择币种
- 统计中按币种分类显示

**命令扩展**：
- `/currency` - 查看当前币种设置
- `/set_currency <base> <quote>` - 设置币种对（管理员）

---

## 📊 开发优先级

### 第一优先级：数据可视化

**原因**：
- 技术难度适中
- 用户需求明确
- 提升用户体验明显

**预计工时**：8 小时

### 第二优先级：API 接口

**原因**：
- 技术难度较高
- 需要完善的认证和权限控制
- 支持第三方集成，扩展性强

**预计工时**：12 小时

### 第三优先级：多币种支持

**原因**：
- 技术难度高
- 需要重构部分核心逻辑
- 数据源需要扩展

**预计工时**：10 小时

---

## 🛠️ 技术依赖

### 数据可视化
- `matplotlib>=3.5.0` - 图表生成
- `numpy>=1.21.0` - 数据处理

### API 接口
- `fastapi>=0.100.0` - Web 框架
- `uvicorn>=0.23.0` - ASGI 服务器
- `python-jose[cryptography]>=3.3.0` - JWT 认证（可选）

### 多币种支持
- 扩展 `requests` 使用（已有）
- 扩展价格服务模块（已有）

---

## 📅 开发时间表

### Week 1: 数据可视化
- Day 1-2: 实现交易趋势图
- Day 3-4: 实现交易量统计图
- Day 5: 实现用户分布图
- Day 6-7: 测试和优化

### Week 2: API 接口
- Day 1-2: 搭建 FastAPI 框架和认证
- Day 3-4: 实现核心 API 接口
- Day 5-6: API Key 管理和文档
- Day 7: 测试和部署

### Week 3: 多币种支持
- Day 1-2: 扩展数据库和价格服务
- Day 3-4: 更新结算逻辑
- Day 5-6: UI 扩展和测试
- Day 7: 集成测试

---

## ✅ 验收标准

### 数据可视化
- [ ] 可以生成交易趋势图表
- [ ] 可以生成交易量统计图表
- [ ] 可以生成用户分布图表
- [ ] 图表清晰易读，自动发送到 Telegram

### API 接口
- [ ] 可以生成和管理 API Key
- [ ] 可以查询汇率、账单、统计
- [ ] 支持请求频率限制
- [ ] 有完整的 API 文档

### 多币种支持
- [ ] 支持 USDC、DAI、USD、EUR
- [ ] 可以切换币种对
- [ ] 结算计算正确
- [ ] UI 支持币种选择

---

**文档版本**：v1.0  
**创建时间**：2025-01-XX  
**状态**：计划中

