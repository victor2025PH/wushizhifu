# Bot B 功能优化方案

## 📋 方案概述

本方案旨在：
1. **实现群组级别的加价管理**（不同群组可设置不同的上浮价格）
2. **扩展更多实用功能**
3. **优化快捷指令体系**（w0-w9，每个指令对应不同功能）

---

## 🎯 一、核心功能升级：群组级别加价管理

### 1.1 数据库结构设计

#### 新增表：`group_settings`
```sql
CREATE TABLE group_settings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    group_id BIGINT NOT NULL,           -- 群组 ID
    group_title TEXT,                   -- 群组标题（缓存）
    markup REAL DEFAULT 0.0,            -- 该群组的上浮价格
    usdt_address TEXT,                  -- 该群组的 USDT 收款地址（可选）
    is_active INTEGER DEFAULT 1,        -- 是否启用
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT,                  -- 最后更新者（管理员 ID）
    UNIQUE(group_id)
);
```

#### 保留全局设置表：`settings`
- `admin_markup`: 全局默认加价（用于未配置的群组）
- `usdt_address`: 全局默认 USDT 地址

### 1.2 加价优先级逻辑

```
计算加价时的优先级：
1. 如果当前消息来自群组 → 使用该群组的加价设置
2. 如果群组未配置 → 使用全局默认加价
3. 如果都未配置 → 使用 0.0
```

### 1.3 功能特性

- ✅ **群组独立加价**：每个群组可设置不同的上浮价格
- ✅ **全局默认值**：未配置的群组使用全局默认加价
- ✅ **群组独立地址**：每个群组可设置独立的 USDT 收款地址
- ✅ **自动识别上下文**：根据消息来源（私聊/群组）自动选择设置

---

## 🔢 二、快捷指令体系优化（w0-w9）

### 2.1 指令分配方案

| 指令 | 功能 | 权限 | 使用场景 |
|------|------|------|----------|
| **w0** | 查看当前群组设置 | 管理员 | 快速查看当前群组的加价和地址 |
| **w1** | 查看价格详情 | 所有人 | 查看当前汇率（Binance P2P + 加价） |
| **w2** | 设置群组加价 | 管理员 | 为当前群组设置上浮价格 |
| **w3** | 设置群组地址 | 管理员 | 为当前群组设置 USDT 收款地址 |
| **w4** | 查看全局设置 | 管理员 | 查看全局默认加价和地址 |
| **w5** | 设置全局加价 | 管理员 | 设置全局默认加价（影响所有未配置的群组） |
| **w6** | 设置全局地址 | 管理员 | 设置全局默认 USDT 地址 |
| **w7** | 查看所有群组列表 | 管理员 | 查看所有已配置的群组及其设置 |
| **w8** | 重置群组设置 | 管理员 | 重置当前群组的加价为全局默认值 |
| **w9** | 删除群组配置 | 管理员 | 删除当前群组的配置（使用全局默认值） |

### 2.2 指令详细说明

#### **w0** - 查看当前群组设置
- **格式**: `w0`
- **权限**: 管理员
- **功能**: 
  - 显示当前群组的加价设置
  - 显示当前群组的 USDT 地址（如果有）
  - 显示是否使用全局默认值
- **示例**:
  ```
  用户: w0
  Bot: 📊 当前群组设置
       ────────────────────────
       群组: 测试群组
       加价: +0.50 CNY
       USDT 地址: 已设置
       ────────────────────────
       使用群组独立设置
  ```

#### **w1** - 查看价格详情（保留原 w01）
- **格式**: `w1`
- **权限**: 所有人
- **功能**: 显示 Binance P2P 价格 + 当前加价（群组或全局）

#### **w2** - 设置群组加价
- **格式**: `w2 [数字]` 或 `w2 [数字] [群组ID]`（管理员可在私聊中指定群组）
- **权限**: 管理员
- **功能**: 为当前群组（或指定群组）设置上浮价格
- **示例**: `w2 0.5` 或 `w2 0.5 -1001234567890`

#### **w3** - 设置群组地址
- **格式**: `w3 [USDT地址]` 或 `w3 [地址] [群组ID]`
- **权限**: 管理员
- **功能**: 为当前群组设置 USDT 收款地址
- **示例**: `w3 TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t`

#### **w4** - 查看全局设置
- **格式**: `w4`
- **权限**: 管理员
- **功能**: 显示全局默认加价和 USDT 地址

#### **w5** - 设置全局加价
- **格式**: `w5 [数字]`（保留原 w02 功能）
- **权限**: 管理员
- **功能**: 设置全局默认加价（影响所有未配置的群组）

#### **w6** - 设置全局地址
- **格式**: `w6 [USDT地址]`（保留原地址设置功能，但改为全局）
- **权限**: 管理员
- **功能**: 设置全局默认 USDT 地址

#### **w7** - 查看所有群组列表
- **格式**: `w7`
- **权限**: 管理员
- **功能**: 显示所有已配置的群组列表，包括加价和地址信息

#### **w8** - 重置群组设置
- **格式**: `w8` 或 `w8 [群组ID]`
- **权限**: 管理员
- **功能**: 将当前群组（或指定群组）的加价重置为全局默认值

#### **w9** - 删除群组配置
- **格式**: `w9` 或 `w9 [群组ID]`
- **权限**: 管理员
- **功能**: 删除群组配置，使其使用全局默认值

---

## 🚀 三、功能扩展方案

### 3.1 交易记录功能

#### 功能描述
- 自动记录每次结算计算
- 支持查看历史记录
- 支持导出记录

#### 数据结构
```sql
CREATE TABLE transactions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    group_id BIGINT,                    -- 群组 ID（如果来自群组）
    user_id BIGINT NOT NULL,            -- 用户 ID
    cny_amount REAL NOT NULL,           -- 人民币金额
    usdt_amount REAL NOT NULL,          -- USDT 数量
    exchange_rate REAL NOT NULL,        -- 使用的汇率
    markup REAL,                        -- 使用的加价
    usdt_address TEXT,                  -- 使用的收款地址
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 相关指令（可扩展）
- `w7` 可扩展：查看交易记录统计
- 新增 `/history` 命令：查看个人/群组交易历史

### 3.2 价格提醒功能

#### 功能描述
- 设置价格阈值提醒
- 当汇率达到设定值时自动通知

#### 数据结构
```sql
CREATE TABLE price_alerts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id BIGINT NOT NULL,
    group_id BIGINT,                    -- 可选：群组级别提醒
    alert_type TEXT,                    -- 'above' 或 'below'
    target_price REAL NOT NULL,         -- 目标价格
    is_active INTEGER DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 相关指令（未来扩展）
- `/alert [above/below] [价格]` - 设置价格提醒
- `/alerts` - 查看所有提醒
- `/delete_alert [ID]` - 删除提醒

### 3.3 批量操作功能

#### 功能描述
- 批量设置多个群组的加价
- 导出/导入群组配置

#### 相关指令（未来扩展）
- `/batch_set_markup [群组ID列表] [加价]` - 批量设置加价
- `/export_config` - 导出所有群组配置（CSV/JSON）
- `/import_config` - 导入群组配置

### 3.4 统计报表功能

#### 功能描述
- 按群组统计交易量
- 按时间段统计
- 生成报表

#### 相关指令（未来扩展）
- `/stats [群组ID] [日期范围]` - 查看统计信息
- `/report [类型]` - 生成报表

### 3.5 多币种支持（未来规划）

#### 功能描述
- 支持 USDT 之外的其他稳定币（USDC, BUSD 等）
- 支持不同的交易对

---

## 📊 四、功能优先级

### 🔴 高优先级（必须实现）
1. ✅ 群组级别加价管理（核心需求）
2. ✅ w0-w9 快捷指令体系
3. ✅ 数据库结构调整（group_settings 表）
4. ✅ 上下文识别（群组 vs 私聊）

### 🟡 中优先级（建议实现）
1. 交易记录功能（w7 扩展）
2. 群组列表查看（w7）
3. 批量设置功能（管理员工具）

### 🟢 低优先级（未来扩展）
1. 价格提醒功能
2. 统计报表功能
3. 导出/导入配置
4. 多币种支持

---

## 🎨 五、用户体验优化

### 5.1 智能上下文识别
- **在群组中**：自动使用该群组的设置
- **在私聊中**：显示全局设置，或允许管理员指定群组

### 5.2 友好的错误提示
- 清晰的格式错误提示
- 权限不足时的友好提示
- 操作成功/失败的明确反馈

### 5.3 帮助信息优化
- `/help` 命令根据用户权限显示不同内容
- 每个指令都有详细的帮助说明
- 提供使用示例

### 5.4 快捷按钮优化
- 根据上下文显示不同的快捷按钮
- 群组中：显示群组相关操作
- 私聊中：显示全局管理操作

---

## 📝 六、数据库迁移方案

### 6.1 迁移步骤
1. 创建 `group_settings` 表
2. 将现有 `settings` 表中的数据迁移为全局默认值
3. 保持 `settings` 表用于全局设置
4. 添加索引优化查询性能

### 6.2 兼容性处理
- 保留原有 API 接口的兼容性
- 逐步迁移现有功能到新体系
- 提供迁移脚本

---

## 🔐 七、权限管理

### 7.1 权限层级
1. **超级管理员**：可管理所有群组和全局设置
2. **群组管理员**：只能管理自己所在群组的设置
3. **普通用户**：只能查看和使用

### 7.2 权限检查
- 所有管理指令都需要验证管理员身份
- 群组操作需要验证用户是否在该群组
- 全局操作需要验证超级管理员身份

---

## 🧪 八、测试方案

### 8.1 单元测试
- 数据库操作测试
- 加价计算逻辑测试
- 指令解析测试

### 8.2 集成测试
- 群组设置流程测试
- 上下文识别测试
- 权限验证测试

### 8.3 用户体验测试
- 指令易用性测试
- 错误处理测试
- 帮助信息完整性测试

---

## 📈 九、实施计划

### 阶段一：核心功能（1-2天）
1. 创建 `group_settings` 表
2. 实现群组加价管理逻辑
3. 实现 w0-w9 基础指令（w0-w6）

### 阶段二：完善功能（1天）
1. 实现 w7-w9 指令
2. 优化用户体验
3. 添加帮助信息

### 阶段三：扩展功能（可选）
1. 交易记录功能
2. 统计报表功能
3. 其他扩展功能

---

## 💡 十、设计亮点

1. **灵活性**：支持群组级别和全局级别的双重设置
2. **易用性**：w0-w9 简洁指令体系，易于记忆
3. **可扩展性**：数据库设计支持未来功能扩展
4. **智能化**：自动识别上下文，减少用户操作
5. **兼容性**：保持向后兼容，平滑迁移

---

## ❓ 十一、待确认问题

1. 是否需要支持多管理员权限管理？
2. 是否需要交易记录功能？（建议保留）
3. 是否需要价格提醒功能？
4. 是否需要支持导出/导入配置？
5. w0-w9 指令分配是否合理？需要调整吗？

---

## 📋 总结

本方案通过：
- **群组级别加价管理**：满足不同群组不同价格的需求
- **w0-w9 指令体系**：简洁易记，功能清晰
- **功能扩展**：为未来扩展预留空间

实现了 Bot B 的核心优化需求，并为后续功能扩展打下基础。

