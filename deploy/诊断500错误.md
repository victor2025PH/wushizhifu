# 500 Internal Server Error 诊断和修复指南

## 🔍 快速诊断步骤

请在服务器上依次执行以下命令来诊断问题：

### 1. 检查前端文件是否存在

```bash
# 检查前端构建文件
ls -la /opt/wushizhifu/frontend/dist/

# 检查 index.html 是否存在
ls -la /opt/wushizhifu/frontend/dist/index.html
```

**预期结果**：应该看到 `index.html` 和静态资源文件（js, css 等）

**如果没有文件**：需要重新构建前端

### 2. 检查文件权限

```bash
# 检查目录权限
ls -ld /opt/wushizhifu/frontend/dist

# 检查文件所有者
ls -la /opt/wushizhifu/frontend/dist/ | head -5
```

**预期结果**：所有者应该是 `www-data:www-data`，权限应该是 `755`

### 3. 检查 Nginx 配置

```bash
# 检查 Nginx 配置语法
sudo nginx -t

# 查看当前运行的 Nginx 配置
sudo cat /etc/nginx/sites-enabled/wushizhifu

# 或查看实际加载的配置
sudo nginx -T | grep -A 30 "server_name 50zf.usdt2026.cc"
```

**预期结果**：
- `nginx -t` 应该显示 "syntax is ok" 和 "test is successful"
- 配置中的 `root` 应该指向正确的路径

### 4. 检查 Nginx 错误日志

```bash
# 查看最近的错误日志
sudo tail -50 /var/log/nginx/error.log

# 实时查看错误日志
sudo tail -f /var/log/nginx/error.log
```

**这是最重要的步骤**：错误日志会显示具体的 500 错误原因

### 5. 检查 Nginx 访问日志

```bash
# 查看最近的访问日志
sudo tail -20 /var/log/nginx/access.log
```

### 6. 检查 API 服务状态（如果使用）

```bash
# 检查 API 服务是否运行
curl http://127.0.0.1:8000/

# 或检查端口占用
sudo netstat -tlnp | grep 8000
```

## 🔧 常见问题和修复方法

### 问题 1: 前端文件不存在

**症状**：`ls -la /opt/wushizhifu/frontend/dist/` 显示文件不存在或目录为空

**修复**：
```bash
cd /opt/wushizhifu/frontend

# 确保 Node.js 已安装
node --version
npm --version

# 安装依赖（如果需要）
npm install

# 重新构建前端
npm run build

# 检查构建结果
ls -la dist/
```

### 问题 2: 文件权限问题

**症状**：Nginx 日志显示 "Permission denied" 或 "403 Forbidden"

**修复**：
```bash
# 设置正确的所有者
sudo chown -R www-data:www-data /opt/wushizhifu/frontend/dist

# 设置正确的权限
sudo chmod -R 755 /opt/wushizhifu/frontend/dist

# 确保父目录也有权限
sudo chmod 755 /opt/wushizhifu
sudo chmod 755 /opt/wushizhifu/frontend
```

### 问题 3: Nginx 配置路径错误

**症状**：Nginx 配置中的路径与实际路径不匹配

**修复**：
```bash
# 查找实际的前端文件位置
find /opt -name "index.html" -type f 2>/dev/null

# 编辑 Nginx 配置
sudo nano /etc/nginx/sites-enabled/wushizhifu

# 修改 root 路径为实际路径，例如：
# root /opt/wushizhifu/frontend/dist;

# 测试并重载配置
sudo nginx -t
sudo systemctl reload nginx
```

### 问题 4: Nginx 无法读取文件

**症状**：错误日志显示 "open() failed" 或 "No such file or directory"

**修复**：
```bash
# 检查 SELinux（如果使用）
getenforce

# 如果 SELinux 是 Enforcing，需要设置上下文
sudo chcon -R -t httpd_sys_content_t /opt/wushizhifu/frontend/dist

# 或者检查 AppArmor
sudo aa-status
```

### 问题 5: SSL 证书问题

**症状**：HTTPS 访问失败，但 HTTP 正常（如果有）

**修复**：
```bash
# 检查 SSL 证书
sudo certbot certificates

# 如果证书过期或不存在，重新申请
sudo certbot --nginx -d 50zf.usdt2026.cc --non-interactive --agree-tos --email victor2018zzz@gmail.com --redirect

# 确保 Nginx 配置中启用了 SSL
sudo nano /etc/nginx/sites-enabled/wushizhifu
# 取消注释或添加 SSL 证书路径
```

## 🚀 快速修复脚本

如果需要快速修复常见问题，可以执行：

```bash
#!/bin/bash
# 快速修复脚本

# 1. 重新构建前端
cd /opt/wushizhifu/frontend
npm run build

# 2. 设置权限
sudo chown -R www-data:www-data /opt/wushizhifu/frontend/dist
sudo chmod -R 755 /opt/wushizhifu/frontend/dist

# 3. 测试并重载 Nginx
sudo nginx -t && sudo systemctl reload nginx

echo "修复完成！请检查网站是否正常。"
```

## 📋 完整检查清单

执行以下命令生成完整报告：

```bash
echo "=== 前端文件检查 ==="
ls -la /opt/wushizhifu/frontend/dist/ 2>&1 | head -10

echo ""
echo "=== Nginx 配置检查 ==="
sudo nginx -t

echo ""
echo "=== Nginx 服务状态 ==="
sudo systemctl status nginx --no-pager -l | head -15

echo ""
echo "=== 最近的错误日志 ==="
sudo tail -20 /var/log/nginx/error.log

echo ""
echo "=== 文件权限检查 ==="
ls -ld /opt/wushizhifu/frontend/dist 2>&1

echo ""
echo "=== API 服务检查 ==="
curl -s http://127.0.0.1:8000/ || echo "API 服务未运行"
```

## 💡 下一步

1. **执行诊断命令**，特别是查看错误日志
2. **将错误日志内容发送给我**，我会帮助分析
3. **根据上面的修复方法**尝试修复常见问题

最关键的步骤是查看 `/var/log/nginx/error.log`，它会告诉你具体的错误原因！

