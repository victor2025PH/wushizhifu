# é—®é¢˜è¯Šæ–­å’Œä¿®å¤æ–¹æ¡ˆ

## é—®é¢˜ä¸€ï¼šMiniApp æ‰“ä¸å¼€ - 403 Forbidden

### é—®é¢˜åˆ†æ

ä»é”™è¯¯ä¿¡æ¯çœ‹ï¼ŒNginx è¿”å›äº† 403 Forbidden é”™è¯¯ï¼Œè¯´æ˜ï¼š
1. **æœåŠ¡å™¨é…ç½®é—®é¢˜**ï¼šNginx æœåŠ¡å™¨æ‹’ç»è®¿é—®è¯¥èµ„æº
2. **å¯èƒ½çš„åŸå› **ï¼š
   - Nginx é…ç½®æ–‡ä»¶ä¸­å¯¹è¯¥è·¯å¾„æœ‰è®¿é—®é™åˆ¶ï¼ˆ`deny all;` æˆ– IP é™åˆ¶ï¼‰
   - æ–‡ä»¶æˆ–ç›®å½•æƒé™ä¸æ­£ç¡®ï¼ˆNginx ç”¨æˆ·æ— æ³•è¯»å–ï¼‰
   - è·¯å¾„é…ç½®é”™è¯¯ï¼ˆroot æˆ– alias é…ç½®ä¸æ­£ç¡®ï¼‰
   - ç¼ºå°‘ index æ–‡ä»¶æˆ–é»˜è®¤æ–‡ä»¶
   - SSL/TLS é…ç½®é—®é¢˜
   - é˜²ç«å¢™æˆ–å®‰å…¨ç»„è§„åˆ™é˜»æ­¢
   - **æ„å»ºç›®å½•ä¸å­˜åœ¨æˆ–è·¯å¾„é”™è¯¯**

### å½“å‰é…ç½®

ä»ä»£ç ä¸­çœ‹åˆ°ï¼š
- **MiniApp URL**: `https://50zf.usdt2026.cc`ï¼ˆåœ¨ `botB/config.py` ä¸­é…ç½®ï¼‰
- **å‰ç«¯æ„å»ºç›®å½•**: `wushizhifu-full/dist`ï¼ˆReact/Vite é¡¹ç›®æ„å»ºåï¼‰
- **Nginx é…ç½®è·¯å¾„**: `/opt/wushizhifu/frontend/dist`ï¼ˆåœ¨ `deploy/nginx.conf` ä¸­ï¼‰
- **API æœåŠ¡å™¨**: `botA/api_server.py`ï¼ˆFastAPIï¼Œç«¯å£ 8000ï¼‰

### å…³é”®å‘ç°

**è·¯å¾„ä¸åŒ¹é…é—®é¢˜**ï¼š
- Nginx é…ç½®æŒ‡å‘ï¼š`/opt/wushizhifu/frontend/dist`
- å®é™…é¡¹ç›®ç›®å½•å¯èƒ½æ˜¯ï¼š`/home/ubuntu/wushizhifu/wushizhifu-full/dist` æˆ– `/opt/wushizhifu/wushizhifu-full/dist`
- éœ€è¦ç¡®è®¤å®é™…æ„å»ºç›®å½•ä½ç½®

### ä¿®å¤æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1ï¼šæ£€æŸ¥å¹¶ä¿®å¤ Nginx é…ç½®å’Œè·¯å¾„ï¼ˆæ¨èï¼‰

**æ­¥éª¤ 1ï¼šç¡®è®¤å®é™…æ„å»ºç›®å½•ä½ç½®**

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼ŒæŸ¥æ‰¾ dist ç›®å½•
find /home /opt -name "index.html" -path "*/wushizhifu*" -type f 2>/dev/null
# æˆ–
find /home /opt -type d -name "dist" -path "*/wushizhifu*" 2>/dev/null
```

**æ­¥éª¤ 2ï¼šæ£€æŸ¥ Nginx é…ç½®æ–‡ä»¶**

```bash
# æŸ¥æ‰¾ 50zf.usdt2026.cc çš„é…ç½®æ–‡ä»¶
sudo nginx -T 2>/dev/null | grep -B 5 -A 20 "server_name 50zf.usdt2026.cc"

# æˆ–ç›´æ¥æŸ¥çœ‹é…ç½®æ–‡ä»¶
sudo cat /etc/nginx/sites-available/50zf.usdt2026.cc
sudo cat /etc/nginx/sites-available/wushizhifu
```

**æ­¥éª¤ 3ï¼šä¿®å¤é…ç½®ï¼ˆæ ¹æ®å®é™…è·¯å¾„ï¼‰**

å¦‚æœå®é™…è·¯å¾„æ˜¯ `/home/ubuntu/wushizhifu/wushizhifu-full/dist`ï¼š

```bash
# ç¼–è¾‘ Nginx é…ç½®
sudo nano /etc/nginx/sites-available/50zf.usdt2026.cc
# æˆ–
sudo nano /etc/nginx/sites-available/wushizhifu
```

ç¡®ä¿é…ç½®å¦‚ä¸‹ï¼š
```nginx
server {
    listen 443 ssl http2;
    server_name 50zf.usdt2026.cc;
    
    # SSL è¯ä¹¦ï¼ˆCertbot ä¼šè‡ªåŠ¨é…ç½®ï¼‰
    ssl_certificate /etc/letsencrypt/live/50zf.usdt2026.cc/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/50zf.usdt2026.cc/privkey.pem;
    
    # å‰ç«¯é™æ€æ–‡ä»¶ - ä¿®æ”¹ä¸ºå®é™…è·¯å¾„
    root /home/ubuntu/wushizhifu/wushizhifu-full/dist;  # æˆ–å®é™…è·¯å¾„
    index index.html;
    
    # ç¡®ä¿æ²¡æœ‰ deny è§„åˆ™
    location / {
        try_files $uri $uri/ /index.html;
        # ä¸è¦æœ‰ deny all;
    }
    
    # API ä»£ç†
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

**æ­¥éª¤ 4ï¼šæ£€æŸ¥æ–‡ä»¶æƒé™**

```bash
# ç¡®ä¿ Nginx ç”¨æˆ·å¯ä»¥è¯»å–æ–‡ä»¶
sudo chown -R www-data:www-data /home/ubuntu/wushizhifu/wushizhifu-full/dist
sudo chmod -R 755 /home/ubuntu/wushizhifu/wushizhifu-full/dist

# æ£€æŸ¥ index.html æ˜¯å¦å­˜åœ¨
ls -la /home/ubuntu/wushizhifu/wushizhifu-full/dist/index.html
```

**æ­¥éª¤ 5ï¼šæµ‹è¯•å¹¶é‡è½½**

```bash
# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡è½½ Nginx
sudo systemctl reload nginx
```

#### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ä¿®å¤è„šæœ¬ï¼ˆå¦‚æœå¯ç”¨ï¼‰

é¡¹ç›®ä¸­æœ‰ä¿®å¤è„šæœ¬ï¼š
```bash
cd /home/ubuntu/wushizhifu
chmod +x deploy/fix_nginx_miniapp.sh
sudo ./deploy/fix_nginx_miniapp.sh
```

#### æ–¹æ¡ˆ 3ï¼šé‡æ–°æ„å»ºå’Œéƒ¨ç½²ï¼ˆæ¨èï¼‰

**é—®é¢˜ç¡®è®¤**ï¼šä»æœåŠ¡å™¨æ£€æŸ¥ç»“æœçœ‹ï¼Œ`/home/ubuntu/wushizhifu/wushizhifu-full/dist` ç›®å½•æ˜¯ç©ºçš„ï¼Œéœ€è¦é‡æ–°æ„å»ºã€‚

**å¿«é€Ÿä¿®å¤æ­¥éª¤**ï¼š

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /home/ubuntu/wushizhifu/wushizhifu-full

# 2. æ£€æŸ¥æ˜¯å¦æœ‰å·²æ„å»ºçš„ distï¼ˆå¯é€‰ï¼‰
# å¦‚æœ /home/ubuntu/wushizhifu/frontend/dist æœ‰æ–‡ä»¶ï¼Œå¯ä»¥å¤åˆ¶ï¼š
if [ -d "/home/ubuntu/wushizhifu/frontend/dist" ] && [ -f "/home/ubuntu/wushizhifu/frontend/dist/index.html" ]; then
    echo "æ‰¾åˆ°å·²æ„å»ºçš„ distï¼Œæ­£åœ¨å¤åˆ¶..."
    sudo rm -rf dist
    sudo mkdir -p dist
    sudo cp -r /home/ubuntu/wushizhifu/frontend/dist/* dist/
    sudo chown -R www-data:www-data dist
    sudo chmod -R 755 dist
    echo "âœ… æ–‡ä»¶å·²å¤åˆ¶"
else
    # 3. å®‰è£…ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if [ ! -d "node_modules" ]; then
        npm install
    fi
    
    # 4. æ¸…ç†å¹¶é‡æ–°æ„å»º
    rm -rf dist
    npm run build
    
    # 5. è®¾ç½®æƒé™
    sudo chown -R www-data:www-data dist
    sudo chmod -R 755 dist
fi

# 6. éªŒè¯æ„å»ºç»“æœ
ls -la dist/
if [ -f "dist/index.html" ]; then
    echo "âœ… æ„å»ºæˆåŠŸï¼"
else
    echo "âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯"
    exit 1
fi

# 7. é‡è½½ Nginx
sudo nginx -t && sudo systemctl reload nginx
```

**æˆ–ä½¿ç”¨ä¿®å¤è„šæœ¬**ï¼ˆå·²åˆ›å»ºï¼‰ï¼š

```bash
cd /home/ubuntu/wushizhifu
chmod +x deploy/ä¿®å¤miniapp_403é”™è¯¯.sh
sudo ./deploy/ä¿®å¤miniapp_403é”™è¯¯.sh
```

#### æ–¹æ¡ˆ 2ï¼šæ£€æŸ¥æ„å»ºå’Œéƒ¨ç½²

1. **ç¡®è®¤å‰ç«¯å·²æ„å»º**ï¼š
   ```bash
   cd wushizhifu-full
   npm run build
   # æ£€æŸ¥ dist ç›®å½•æ˜¯å¦ç”Ÿæˆ
   ```

2. **æ£€æŸ¥éƒ¨ç½²è·¯å¾„**ï¼š
   - ç¡®è®¤ Nginx çš„ `root` æˆ– `alias` æŒ‡å‘æ­£ç¡®çš„æ„å»ºç›®å½•
   - ç¡®è®¤ `index.html` æ–‡ä»¶å­˜åœ¨

#### æ–¹æ¡ˆ 3ï¼šæ£€æŸ¥ SSL è¯ä¹¦

å¦‚æœä½¿ç”¨ HTTPSï¼š
```bash
# æ£€æŸ¥è¯ä¹¦æ˜¯å¦æœ‰æ•ˆ
openssl s_client -connect 50zf.usdt2026.cc:443 -servername 50zf.usdt2026.cc
```

#### æ–¹æ¡ˆ 4ï¼šä¸´æ—¶æµ‹è¯•ï¼ˆHTTPï¼‰

å¦‚æœ HTTPS æœ‰é—®é¢˜ï¼Œå¯ä»¥ä¸´æ—¶ä½¿ç”¨ HTTP æµ‹è¯•ï¼š
```nginx
server {
    listen 80;
    server_name 50zf.usdt2026.cc;
    root /path/to/wushizhifu-full/dist;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

### è¯Šæ–­æ­¥éª¤

1. **æ£€æŸ¥ Nginx é”™è¯¯æ—¥å¿—**ï¼š
   ```bash
   tail -f /var/log/nginx/error.log
   ```

2. **æ£€æŸ¥ Nginx è®¿é—®æ—¥å¿—**ï¼š
   ```bash
   tail -f /var/log/nginx/access.log
   ```

3. **æµ‹è¯• Nginx é…ç½®**ï¼š
   ```bash
   nginx -t
   ```

4. **é‡è½½ Nginx**ï¼š
   ```bash
   systemctl reload nginx
   # æˆ–
   nginx -s reload
   ```

---

## é—®é¢˜äºŒï¼šBot B ç‚¹å‡»åœ°å€ç®¡ç†æ²¡æœ‰å“åº”

### é—®é¢˜åˆ†æ

ä»ä»£ç åˆ†æï¼š
1. **æŒ‰é’®å›è°ƒæ•°æ®**ï¼š`callback_data="address_list"`ï¼ˆåœ¨ `inline_keyboard.py` ç¬¬ 224 å’Œ 569 è¡Œï¼‰
2. **å›è°ƒå¤„ç†å™¨**ï¼šåœ¨ `callback_handlers.py` ç¬¬ 1189 è¡Œæœ‰å¤„ç† `address_list` çš„é€»è¾‘
3. **å¯èƒ½çš„é—®é¢˜**ï¼š
   - å›è°ƒå¤„ç†å™¨è·¯ç”±é¡ºåºé—®é¢˜ï¼ˆå¯èƒ½è¢«å…¶ä»–å¤„ç†å™¨æ‹¦æˆªï¼‰
   - `handle_address_list` å‡½æ•°ä¸­çš„é”™è¯¯å¯¼è‡´é™é»˜å¤±è´¥
   - `group_id` è·å–å¤±è´¥ï¼ˆåœ¨ç§èŠä¸­éœ€è¦ä» context è·å–ï¼‰
   - æƒé™æ£€æŸ¥å¤±è´¥ä½†æ²¡æœ‰æ­£ç¡®æç¤º

### å½“å‰ä»£ç æµç¨‹

1. **æŒ‰é’®å®šä¹‰**ï¼ˆ`inline_keyboard.py`ï¼‰ï¼š
   ```python
   InlineKeyboardButton("ğŸ“ åœ°å€ç®¡ç†", callback_data="address_list")
   ```

2. **å›è°ƒå¤„ç†**ï¼ˆ`callback_handlers.py` ç¬¬ 1189 è¡Œï¼‰ï¼š
   ```python
   if callback_data == "address_list" or callback_data == "address_manage":
       from handlers.address_handlers import handle_address_list
       await handle_address_list(update, context)
       return
   ```

3. **åœ°å€åˆ—è¡¨å¤„ç†**ï¼ˆ`address_handlers.py`ï¼‰ï¼š
   - éœ€è¦ `group_id`ï¼ˆä» chat æˆ– context è·å–ï¼‰
   - éœ€è¦ç®¡ç†å‘˜æƒé™

### ä¿®å¤æ–¹æ¡ˆ

#### å·²å‘ç°çš„é—®é¢˜

1. **ç¼©è¿›é”™è¯¯**ï¼š`address_handlers.py` ç¬¬ 118 è¡Œå’Œ 310 è¡Œã€327 è¡Œæœ‰ç¼©è¿›é”™è¯¯
2. **group_id è·å–é€»è¾‘**ï¼šéœ€è¦ç¡®ä¿ä» context æ­£ç¡®è·å–
3. **é”™è¯¯å¤„ç†ä¸å®Œå–„**ï¼šç¼ºå°‘è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œç”¨æˆ·åé¦ˆ

#### ä¿®å¤æ­¥éª¤

**ä¿®å¤ 1ï¼šä¿®å¤ç¼©è¿›é”™è¯¯**

å·²ä¿®å¤ `address_handlers.py` ä¸­çš„ç¼©è¿›é—®é¢˜ã€‚

**ä¿®å¤ 2ï¼šå¢å¼º group_id è·å–é€»è¾‘**

å·²æ›´æ–° `handle_address_list`ï¼Œæ·»åŠ ï¼š
- æ›´è¯¦ç»†çš„æ—¥å¿—è®°å½•
- æ›´å¥½çš„é”™è¯¯æç¤º
- ç¡®ä¿ä» context æ­£ç¡®è·å– `selected_group_id`

**ä¿®å¤ 3ï¼šå¢å¼ºå›è°ƒå¤„ç†**

å·²æ›´æ–° `callback_handlers.py`ï¼Œæ·»åŠ ï¼š
- é”™è¯¯æ•è·å’Œæ—¥å¿—
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
- ç¡®ä¿ `selected_group_id` æ­£ç¡®ä¿å­˜

**ä¿®å¤ 4ï¼šæ·»åŠ è°ƒè¯•ä¿¡æ¯**

åœ¨å…³é”®ä½ç½®æ·»åŠ æ—¥å¿—ï¼Œå¸®åŠ©è¯Šæ–­é—®é¢˜ã€‚

---

## ä¿®å¤ä¼˜å…ˆçº§

1. **é«˜ä¼˜å…ˆçº§**ï¼šé—®é¢˜äºŒï¼ˆåœ°å€ç®¡ç†æŒ‰é’®ï¼‰- å½±å“ç”¨æˆ·ä½“éªŒ
2. **ä¸­ä¼˜å…ˆçº§**ï¼šé—®é¢˜ä¸€ï¼ˆMiniApp 403ï¼‰- éœ€è¦æœåŠ¡å™¨è®¿é—®æƒé™

## å»ºè®®çš„ä¿®å¤é¡ºåº

1. å…ˆä¿®å¤åœ°å€ç®¡ç†æŒ‰é’®é—®é¢˜ï¼ˆä»£ç å±‚é¢ï¼‰
2. ç„¶åæ£€æŸ¥ MiniApp 403 é—®é¢˜ï¼ˆéœ€è¦æœåŠ¡å™¨è®¿é—®ï¼‰
