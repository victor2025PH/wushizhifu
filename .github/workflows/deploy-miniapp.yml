name: Deploy Miniapp

on:
  push:
    branches:
      - main
    paths:
      - 'wushizhifu-full/**'
      - 'api_server.py'
      - '.github/workflows/deploy-miniapp.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Pull Code and Build
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 600s
          script: |
            cd /home/ubuntu/wushizhifu
            git stash || true
            git pull origin main
            
            # 进入 wushizhifu-full 目录（统一使用 wushizhifu-full，不再使用 repo/wushizhifu-full）
            if [ ! -d "wushizhifu-full" ]; then
              echo "❌ 错误: 找不到 wushizhifu-full 目录"
              exit 1
            fi
            cd wushizhifu-full
            
            # 如果是 Git 子模块，确保更新
            if [ -f ".git" ] || [ -d ".git" ]; then
              echo "📥 更新 Git 子模块..."
              git pull origin main || true
            fi
            
            # 安装依赖
            echo "📦 安装依赖..."
            npm install --production=false || {
              echo "⚠️  npm install 失败，尝试清理后重试..."
              rm -rf node_modules package-lock.json
              npm install --production=false
            }
            
            # 构建项目
            echo "🔨 构建项目..."
            export NODE_OPTIONS="--max-old-space-size=3072"
            npm run build || {
              echo "❌ 构建失败，查看详细错误："
              npm run build 2>&1 | tail -50
              exit 1
            }
            
            # 检查构建结果
            if [ ! -d "dist" ]; then
              echo "❌ dist 目录不存在"
              exit 1
            fi
            
            # 验证构建结果
            echo "🔍 验证构建结果..."
            FILE_COUNT=$(find dist -type f 2>/dev/null | wc -l)
            echo "  构建文件数量: $FILE_COUNT"
            
            if [ "$FILE_COUNT" -lt 5 ]; then
              echo "⚠️ 警告: 构建文件数量过少 ($FILE_COUNT)，可能构建不完整"
              echo "  检查dist目录内容:"
              ls -la dist/ | head -20
            fi
            
            # 检查关键文件
            if [ ! -f "dist/index.html" ]; then
              echo "❌ 构建失败: dist/index.html 不存在"
              exit 1
            fi
            
            echo "✅ 构建完成并验证通过"
      
      - name: Deploy Frontend
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 300s
          script: |
            cd /home/ubuntu/wushizhifu
            
            # 清理旧的 repo 目录（历史遗留，现在不再需要）
            if [ -d "repo" ]; then
              echo "🧹 清理旧的 repo 目录（历史遗留，现在不再需要）..."
              REPO_BACKUP="repo.backup.$(date +%Y%m%d_%H%M%S)"
              mv repo "$REPO_BACKUP" 2>/dev/null || sudo mv repo "$REPO_BACKUP" || true
              echo "✅ repo 目录已备份到: $REPO_BACKUP"
              echo "   如果一切正常，可以稍后删除备份: rm -rf $REPO_BACKUP"
            fi
            
            # 确定源目录（直接使用 wushizhifu-full/dist，不再复制）
            SOURCE_DIR="/home/ubuntu/wushizhifu/wushizhifu-full/dist"
            if [ ! -d "$SOURCE_DIR" ]; then
              echo "❌ 错误: 找不到构建后的 dist 目录: $SOURCE_DIR"
              exit 1
            fi
            
            # 验证构建结果
            echo "🔍 验证构建结果..."
            FILE_COUNT=$(find "$SOURCE_DIR" -type f 2>/dev/null | wc -l)
            echo "  构建文件数量: $FILE_COUNT"
            
            if [ "$FILE_COUNT" -lt 5 ]; then
              echo "⚠️ 警告: 构建文件数量过少 ($FILE_COUNT)，可能构建不完整"
              echo "  检查dist目录内容:"
              ls -la "$SOURCE_DIR" | head -20
            fi
            
            # 检查关键文件
            if [ ! -f "$SOURCE_DIR/index.html" ]; then
              echo "❌ 构建失败: $SOURCE_DIR/index.html 不存在"
              exit 1
            fi
            echo "✅ 构建验证通过"
            
            # 设置文件权限（直接对源目录设置）
            echo "🔐 设置文件权限..."
            sudo chown -R www-data:www-data "$SOURCE_DIR"
            sudo chmod -R 755 "$SOURCE_DIR"
            echo "✅ 权限设置完成"
            
            # 更新 Nginx 配置
            NGINX_CONFIG="/etc/nginx/sites-available/50zf.usdt2026.cc"
            if [ ! -f "$NGINX_CONFIG" ]; then
              # 如果配置文件不存在，尝试查找其他可能的配置文件名
              NGINX_CONFIG="/etc/nginx/sites-available/wushizhifu"
            fi
            
            if [ -f "$NGINX_CONFIG" ]; then
              echo "🔧 更新 Nginx 配置..."
              # 更新 root 路径为正确的 wushizhifu-full/dist
              EXPECTED_ROOT="/home/ubuntu/wushizhifu/wushizhifu-full/dist"
              sudo sed -i "s|root .*;|root $EXPECTED_ROOT;|g" "$NGINX_CONFIG"
              echo "✅ Nginx 配置已更新"
              
              # 验证配置
              ACTUAL_ROOT=$(sudo nginx -T 2>/dev/null | grep -A 10 "server_name 50zf.usdt2026.cc" | grep "root" | head -1 | awk '{print $2}' | sed 's/;//')
              echo "  当前root: $ACTUAL_ROOT"
              echo "  期望root: $EXPECTED_ROOT"
              if [ "$ACTUAL_ROOT" = "$EXPECTED_ROOT" ]; then
                echo "✅ Nginx配置验证通过"
              else
                echo "⚠️ Nginx配置可能不正确，但继续部署"
              fi
            else
              echo "⚠️  Nginx 配置文件不存在: $NGINX_CONFIG"
              echo "   使用修复脚本创建配置..."
              if [ -f "/home/ubuntu/wushizhifu/deploy/fix_nginx_configs_complete.sh" ]; then
                chmod +x /home/ubuntu/wushizhifu/deploy/fix_nginx_configs_complete.sh
                /home/ubuntu/wushizhifu/deploy/fix_nginx_configs_complete.sh || echo "⚠️ 修复脚本执行完成（可能有警告）"
              fi
            fi
            
            # 重载 Nginx
            echo "🔄 重载 Nginx..."
            sudo nginx -t && sudo systemctl reload nginx || {
              echo "⚠️  Nginx 重载失败，请检查配置"
            }
            
            # 启动/重启 API 服务（完整自动化诊断和修复）
            echo "🔄 启动/重启 API 服务..."
            API_FILE="/home/ubuntu/wushizhifu/api_server.py"
            SERVICE_NAME="wushipay-api"
            PROJECT_ROOT="/home/ubuntu/wushizhifu"
            
            if [ -f "$API_FILE" ]; then
              echo "📋 步骤 1: 检查并创建虚拟环境（如果需要）..."
              if [ ! -d "$PROJECT_ROOT/venv" ]; then
                echo "   创建虚拟环境..."
                cd "$PROJECT_ROOT"
                python3 -m venv venv || python3 -m virtualenv venv
              fi
              
              echo "📋 步骤 2: 安装 Python 依赖..."
              if [ -f "$PROJECT_ROOT/venv/bin/pip" ]; then
                $PROJECT_ROOT/venv/bin/pip install --upgrade pip -q || true
                $PROJECT_ROOT/venv/bin/pip install -q fastapi uvicorn python-multipart httpx requests python-dotenv || true
                if [ -f "$PROJECT_ROOT/requirements.txt" ]; then
                  $PROJECT_ROOT/venv/bin/pip install -q -r "$PROJECT_ROOT/requirements.txt" || true
                fi
              else
                pip3 install --user --upgrade pip -q || true
                pip3 install --user -q fastapi uvicorn python-multipart httpx requests python-dotenv || true
                if [ -f "$PROJECT_ROOT/requirements.txt" ]; then
                  pip3 install --user -q -r "$PROJECT_ROOT/requirements.txt" || true
                fi
              fi
              
              echo "📋 步骤 3: 检查并创建 Systemd 服务文件..."
              if [ ! -f "/etc/systemd/system/${SERVICE_NAME}.service" ]; then
                echo "   服务文件不存在，创建服务..."
                
                # 确定 Python 和 uvicorn 路径
                if [ -f "$PROJECT_ROOT/venv/bin/uvicorn" ]; then
                  UVICORN_CMD="$PROJECT_ROOT/venv/bin/uvicorn"
                elif [ -f "$PROJECT_ROOT/venv/bin/python3" ]; then
                  UVICORN_CMD="$PROJECT_ROOT/venv/bin/python3 -m uvicorn"
                else
                  UVICORN_CMD="python3 -m uvicorn"
                fi
                
                # 使用模板文件创建服务（模板应该总是存在）
                if [ -f "$PROJECT_ROOT/deploy/systemd/wushipay-api.service" ]; then
                  sudo cp "$PROJECT_ROOT/deploy/systemd/wushipay-api.service" "/etc/systemd/system/${SERVICE_NAME}.service"
                  sudo sed -i "s|/home/ubuntu/wushizhifu|$PROJECT_ROOT|g" "/etc/systemd/system/${SERVICE_NAME}.service"
                  echo "✅ 使用模板文件创建服务"
                else
                  echo "⚠️  警告: 服务模板文件不存在: $PROJECT_ROOT/deploy/systemd/wushipay-api.service"
                  echo "   服务文件应该在仓库中，请检查文件是否存在"
                  echo "   跳过服务创建，请手动创建服务文件"
                fi
                sudo systemctl daemon-reload
                echo "✅ Systemd 服务文件已创建"
              else
                echo "✅ 服务文件已存在"
              fi
              
              echo "📋 步骤 4: 停止占用端口的进程..."
              if command -v lsof > /dev/null 2>&1; then
                if lsof -i:8000 > /dev/null 2>&1; then
                  echo "   发现端口 8000 被占用，停止进程..."
                  sudo kill -9 $(lsof -t -i:8000) 2>/dev/null || true
                  sleep 2
                fi
              else
                # 如果没有 lsof，使用 netstat 或 ss
                if command -v ss > /dev/null 2>&1; then
                  PID=$(sudo ss -tlnp | grep :8000 | awk '{print $6}' | cut -d',' -f2 | cut -d'=' -f2 | head -1)
                  if [ -n "$PID" ]; then
                    echo "   发现端口 8000 被占用，停止进程 $PID..."
                    sudo kill -9 $PID 2>/dev/null || true
                    sleep 2
                  fi
                fi
              fi
              
              echo "📋 步骤 5: 启用并启动服务..."
              sudo systemctl enable ${SERVICE_NAME} || true
              sudo systemctl restart ${SERVICE_NAME} || sudo systemctl start ${SERVICE_NAME}
              
              echo "📋 步骤 6: 等待服务启动..."
              sleep 3
              
              echo "📋 步骤 7: 验证服务状态..."
              if systemctl is-active --quiet ${SERVICE_NAME}; then
                echo "✅ API 服务已成功启动"
                
                # 测试 API 端点
                echo "📋 步骤 8: 测试 API 端点..."
                sleep 2
                if curl -s http://127.0.0.1:8000/ > /dev/null 2>&1; then
                  echo "✅ API 服务响应正常"
                else
                  echo "⚠️  API 服务运行但无法响应，查看日志:"
                  sudo journalctl -u ${SERVICE_NAME} -n 20 --no-pager || true
                fi
              else
                echo "❌ API 服务启动失败，诊断问题..."
                echo "   服务状态:"
                sudo systemctl status ${SERVICE_NAME} --no-pager -l | head -30 || true
                echo ""
                echo "   最近日志:"
                sudo journalctl -u ${SERVICE_NAME} -n 30 --no-pager || true
                echo ""
                echo "   尝试手动启动以查看详细错误..."
                cd "$PROJECT_ROOT"
                if [ -f "$PROJECT_ROOT/venv/bin/python3" ]; then
                  $PROJECT_ROOT/venv/bin/python3 -c "import api_server" 2>&1 | head -20 || echo "无法导入 api_server 模块"
                fi
              fi
            else
              echo "⚠️  API 文件不存在: $API_FILE"
              echo "   跳过 API 服务启动"
            fi
            
            echo "✅ 部署完成"
            echo "🌐 访问: https://50zf.usdt2026.cc"

