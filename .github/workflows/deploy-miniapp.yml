name: Deploy Miniapp

on:
  push:
    branches:
      - main
    paths:
      - 'wushizhifu-full/**'
      - 'api_server.py'
      - '.github/workflows/deploy-miniapp.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Pull Code and Build
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 600s
          script: |
            cd /home/ubuntu/wushizhifu
            git stash || true
            git pull origin main
            
            # è¿›å…¥ wushizhifu-full ç›®å½•
            if [ -d "repo/wushizhifu-full" ]; then
              cd repo/wushizhifu-full
            elif [ -d "wushizhifu-full" ]; then
              cd wushizhifu-full
            else
              echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° wushizhifu-full ç›®å½•"
              exit 1
            fi
            
            # å®‰è£…ä¾èµ–
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            npm install --production=false || {
              echo "âš ï¸  npm install å¤±è´¥ï¼Œå°è¯•æ¸…ç†åé‡è¯•..."
              rm -rf node_modules package-lock.json
              npm install --production=false
            }
            
            # æ„å»ºé¡¹ç›®
            echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
            export NODE_OPTIONS="--max-old-space-size=3072"
            npm run build || {
              echo "âŒ æ„å»ºå¤±è´¥"
              exit 1
            }
            
            # æ£€æŸ¥æ„å»ºç»“æœ
            if [ ! -d "dist" ]; then
              echo "âŒ dist ç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
            
            echo "âœ… æ„å»ºå®Œæˆ"
      
      - name: Deploy Frontend
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 300s
          script: |
            cd /home/ubuntu/wushizhifu
            
            # ç¡®å®šæºç›®å½•å’Œç›®æ ‡ç›®å½•
            if [ -d "repo/wushizhifu-full/dist" ]; then
              SOURCE_DIR="repo/wushizhifu-full/dist"
            elif [ -d "wushizhifu-full/dist" ]; then
              SOURCE_DIR="wushizhifu-full/dist"
            else
              echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°æ„å»ºåçš„ dist ç›®å½•"
              exit 1
            fi
            
            TARGET_DIR="$HOME/wushizhifu/frontend"
            
            # å¤‡ä»½ç°æœ‰ç›®å½•
            if [ -d "$TARGET_DIR" ]; then
              echo "ğŸ“¦ å¤‡ä»½ç°æœ‰ç›®å½•..."
              mv "$TARGET_DIR" "${TARGET_DIR}.backup.$(date +%Y%m%d_%H%M%S)" || rm -rf "$TARGET_DIR"
            fi
            
            # å¤åˆ¶æ„å»ºç»“æœ
            echo "ğŸ“‹ å¤åˆ¶æ„å»ºç»“æœ..."
            mkdir -p "$TARGET_DIR"
            cp -r "$SOURCE_DIR"/* "$TARGET_DIR"/
            echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ"
            
            # æ£€æŸ¥å¹¶å®‰è£… serveï¼ˆå¦‚æœéœ€è¦ï¼‰
            if ! command -v serve >/dev/null 2>&1; then
              echo "ğŸ“¦ å®‰è£… serve..."
              sudo npm install -g serve || true
            fi
            
            # åœæ­¢æ—§çš„ PM2 è¿›ç¨‹
            pm2 delete miniapp-frontend 2>/dev/null || true
            
            # å¯åŠ¨æ–°çš„ PM2 è¿›ç¨‹ï¼ˆå¦‚æœéœ€è¦ï¼‰
            # æ³¨æ„ï¼šå¦‚æœä½¿ç”¨ Nginx ç›´æ¥æœåŠ¡é™æ€æ–‡ä»¶ï¼Œå¯èƒ½ä¸éœ€è¦ PM2
            # è¿™é‡Œå…ˆæ£€æŸ¥æ˜¯å¦æœ‰ PM2 è¿›ç¨‹ï¼Œå¦‚æœæ²¡æœ‰åˆ™å¯åŠ¨
            if ! pm2 list | grep -q "miniapp-frontend"; then
              echo "ğŸš€ å¯åŠ¨ PM2 è¿›ç¨‹..."
              pm2 start "npx serve -s $TARGET_DIR -l 5000" --name miniapp-frontend || {
                echo "âš ï¸  PM2 å¯åŠ¨å¤±è´¥ï¼Œå¯èƒ½ä½¿ç”¨ Nginx ç›´æ¥æœåŠ¡"
              }
              pm2 save || true
            else
              echo "âœ… PM2 è¿›ç¨‹å·²åœ¨è¿è¡Œ"
            fi
            
            # é‡å¯ API æœåŠ¡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -f "/home/ubuntu/wushizhifu/api_server.py" ]; then
              echo "ğŸ”„ é‡å¯ API æœåŠ¡..."
              sudo systemctl restart wushipay-api.service || true
            fi
            
            echo "âœ… éƒ¨ç½²å®Œæˆ"
            echo "ğŸŒ è®¿é—®: https://50zf.usdt2026.cc"

