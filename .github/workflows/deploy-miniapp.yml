name: Deploy Miniapp

on:
  push:
    branches:
      - main
    paths:
      - 'wushizhifu-full/**'
      - 'api_server.py'
      - '.github/workflows/deploy-miniapp.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Pull Code and Build
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 600s
          script: |
            cd /home/ubuntu/wushizhifu
            git stash || true
            git pull origin main
            
            # è¿›å…¥ wushizhifu-full ç›®å½•
            if [ -d "repo/wushizhifu-full" ]; then
              cd repo/wushizhifu-full
            elif [ -d "wushizhifu-full" ]; then
              cd wushizhifu-full
            else
              echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° wushizhifu-full ç›®å½•"
              exit 1
            fi
            
            # å®‰è£…ä¾èµ–
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            npm install --production=false || {
              echo "âš ï¸  npm install å¤±è´¥ï¼Œå°è¯•æ¸…ç†åé‡è¯•..."
              rm -rf node_modules package-lock.json
              npm install --production=false
            }
            
            # æ„å»ºé¡¹ç›®
            echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
            export NODE_OPTIONS="--max-old-space-size=3072"
            npm run build || {
              echo "âŒ æ„å»ºå¤±è´¥"
              exit 1
            }
            
            # æ£€æŸ¥æ„å»ºç»“æœ
            if [ ! -d "dist" ]; then
              echo "âŒ dist ç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
            
            echo "âœ… æ„å»ºå®Œæˆ"
      
      - name: Deploy Frontend
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 300s
          script: |
            cd /home/ubuntu/wushizhifu
            
            # ç¡®å®šæºç›®å½•å’Œç›®æ ‡ç›®å½•
            if [ -d "repo/wushizhifu-full/dist" ]; then
              SOURCE_DIR="repo/wushizhifu-full/dist"
            elif [ -d "wushizhifu-full/dist" ]; then
              SOURCE_DIR="wushizhifu-full/dist"
            else
              echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°æ„å»ºåçš„ dist ç›®å½•"
              exit 1
            fi
            
            TARGET_DIR="$HOME/wushizhifu/frontend"
            
            # å¤‡ä»½ç°æœ‰ç›®å½•
            if [ -d "$TARGET_DIR" ]; then
              echo "ğŸ“¦ å¤‡ä»½ç°æœ‰ç›®å½•..."
              mv "$TARGET_DIR" "${TARGET_DIR}.backup.$(date +%Y%m%d_%H%M%S)" || rm -rf "$TARGET_DIR"
            fi
            
            # å¤åˆ¶æ„å»ºç»“æœåˆ° frontend/dist
            echo "ğŸ“‹ å¤åˆ¶æ„å»ºç»“æœ..."
            mkdir -p "$TARGET_DIR/dist"
            cp -r "$SOURCE_DIR"/* "$TARGET_DIR/dist/"
            echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ"
            
            # è®¾ç½®æ–‡ä»¶æƒé™
            echo "ğŸ” è®¾ç½®æ–‡ä»¶æƒé™..."
            sudo chown -R www-data:www-data "$TARGET_DIR" || sudo chown -R ubuntu:ubuntu "$TARGET_DIR"
            sudo chmod -R 755 "$TARGET_DIR"
            echo "âœ… æƒé™è®¾ç½®å®Œæˆ"
            
            # æ›´æ–° Nginx é…ç½®
            NGINX_CONFIG="/etc/nginx/sites-available/50zf.usdt2026.cc"
            if [ ! -f "$NGINX_CONFIG" ]; then
              # å¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°è¯•æŸ¥æ‰¾å…¶ä»–å¯èƒ½çš„é…ç½®æ–‡ä»¶å
              NGINX_CONFIG="/etc/nginx/sites-available/wushizhifu"
            fi
            
            if [ -f "$NGINX_CONFIG" ]; then
              echo "ğŸ”§ æ›´æ–° Nginx é…ç½®..."
              # æ›´æ–° root è·¯å¾„
              sudo sed -i "s|root /.*/frontend/dist;|root $TARGET_DIR;|g" "$NGINX_CONFIG"
              sudo sed -i "s|root /.*/frontend;|root $TARGET_DIR;|g" "$NGINX_CONFIG"
              echo "âœ… Nginx é…ç½®å·²æ›´æ–°"
            else
              echo "âš ï¸  Nginx é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $NGINX_CONFIG"
              echo "   è¯·æ‰‹åŠ¨åˆ›å»ºæˆ–æ£€æŸ¥é…ç½®æ–‡ä»¶ä½ç½®"
            fi
            
            # é‡è½½ Nginx
            echo "ğŸ”„ é‡è½½ Nginx..."
            sudo nginx -t && sudo systemctl reload nginx || {
              echo "âš ï¸  Nginx é‡è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®"
            }
            
            # é‡å¯ API æœåŠ¡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -f "/home/ubuntu/wushizhifu/api_server.py" ]; then
              echo "ğŸ”„ é‡å¯ API æœåŠ¡..."
              sudo systemctl restart wushipay-api.service || true
            fi
            
            echo "âœ… éƒ¨ç½²å®Œæˆ"
            echo "ğŸŒ è®¿é—®: https://50zf.usdt2026.cc"

