name: Deploy Miniapp

on:
  push:
    branches:
      - main
    paths:
      - 'wushizhifu-full/**'
      - 'api_server.py'
      - '.github/workflows/deploy-miniapp.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Pull Code and Build
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 600s
          script: |
            cd /home/ubuntu/wushizhifu
            git stash || true
            git pull origin main
            
            # è¿›å…¥ wushizhifu-full ç›®å½•ï¼ˆç»Ÿä¸€ä½¿ç”¨ wushizhifu-fullï¼Œä¸å†ä½¿ç”¨ repo/wushizhifu-fullï¼‰
            if [ ! -d "wushizhifu-full" ]; then
              echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° wushizhifu-full ç›®å½•"
              exit 1
            fi
            cd wushizhifu-full
            
            # å¦‚æœæ˜¯ Git å­æ¨¡å—ï¼Œç¡®ä¿æ›´æ–°
            if [ -f ".git" ] || [ -d ".git" ]; then
              echo "ğŸ“¥ æ›´æ–° Git å­æ¨¡å—..."
              git pull origin main || true
            fi
            
            # å®‰è£…ä¾èµ–
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            npm install --production=false || {
              echo "âš ï¸  npm install å¤±è´¥ï¼Œå°è¯•æ¸…ç†åé‡è¯•..."
              rm -rf node_modules package-lock.json
              npm install --production=false
            }
            
            # æ„å»ºé¡¹ç›®
            echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
            export NODE_OPTIONS="--max-old-space-size=3072"
            npm run build || {
              echo "âŒ æ„å»ºå¤±è´¥"
              exit 1
            }
            
            # æ£€æŸ¥æ„å»ºç»“æœ
            if [ ! -d "dist" ]; then
              echo "âŒ dist ç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
            
            echo "âœ… æ„å»ºå®Œæˆ"
      
      - name: Deploy Frontend
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 300s
          script: |
            cd /home/ubuntu/wushizhifu
            
            # æ¸…ç†æ—§çš„ repo ç›®å½•ï¼ˆå†å²é—ç•™ï¼Œç°åœ¨ä¸å†éœ€è¦ï¼‰
            if [ -d "repo" ]; then
              echo "ğŸ§¹ æ¸…ç†æ—§çš„ repo ç›®å½•ï¼ˆå†å²é—ç•™ï¼Œç°åœ¨ä¸å†éœ€è¦ï¼‰..."
              REPO_BACKUP="repo.backup.$(date +%Y%m%d_%H%M%S)"
              mv repo "$REPO_BACKUP" 2>/dev/null || sudo mv repo "$REPO_BACKUP" || true
              echo "âœ… repo ç›®å½•å·²å¤‡ä»½åˆ°: $REPO_BACKUP"
              echo "   å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œå¯ä»¥ç¨ååˆ é™¤å¤‡ä»½: rm -rf $REPO_BACKUP"
            fi
            
            # ç¡®å®šæºç›®å½•å’Œç›®æ ‡ç›®å½•ï¼ˆç»Ÿä¸€ä½¿ç”¨ wushizhifu-fullï¼‰
            SOURCE_DIR="/home/ubuntu/wushizhifu/wushizhifu-full/dist"
            if [ ! -d "$SOURCE_DIR" ]; then
              echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°æ„å»ºåçš„ dist ç›®å½•: $SOURCE_DIR"
              exit 1
            fi
            
            TARGET_DIR="$HOME/wushizhifu/frontend/dist"
            
            # ä½¿ç”¨ sudo å½»åº•åˆ é™¤æ—§æ–‡ä»¶ï¼ˆè§£å†³æƒé™é—®é¢˜ï¼‰
            if [ -d "$TARGET_DIR" ]; then
              echo "ğŸ“¦ åˆ é™¤æ—§éƒ¨ç½²æ–‡ä»¶..."
              sudo rm -rf "$TARGET_DIR"/*
              sudo rm -rf "$TARGET_DIR"/.[^.]* 2>/dev/null || true
              # å¦‚æœç›®å½•è¿˜å­˜åœ¨ï¼Œç¡®ä¿æ˜¯ç©ºçš„
              if [ -d "$TARGET_DIR" ]; then
                REMAINING=$(find "$TARGET_DIR" -mindepth 1 2>/dev/null | wc -l)
                if [ "$REMAINING" -gt 0 ]; then
                  echo "âš ï¸  ä»æœ‰æ–‡ä»¶æ®‹ç•™ï¼Œå¼ºåˆ¶åˆ é™¤ç›®å½•..."
                  sudo rm -rf "$TARGET_DIR"
                  sudo mkdir -p "$TARGET_DIR"
                fi
              else
                sudo mkdir -p "$TARGET_DIR"
              fi
              echo "âœ… æ—§æ–‡ä»¶å·²åˆ é™¤"
            else
              sudo mkdir -p "$TARGET_DIR"
            fi
            
            # å¤åˆ¶æ„å»ºç»“æœåˆ° frontend/dist
            echo "ğŸ“‹ å¤åˆ¶æ„å»ºç»“æœ..."
            echo "æºç›®å½•: $SOURCE_DIR"
            echo "ç›®æ ‡ç›®å½•: $TARGET_DIR"
            # ä½¿ç”¨ sudo å¤åˆ¶ä»¥ç¡®ä¿æƒé™æ­£ç¡®
            sudo cp -r "$SOURCE_DIR"/* "$TARGET_DIR"/
            sudo cp -r "$SOURCE_DIR"/.[^.]* "$TARGET_DIR"/ 2>/dev/null || true
            echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ"
            
            # è®¾ç½®æ–‡ä»¶æƒé™
            echo "ğŸ” è®¾ç½®æ–‡ä»¶æƒé™..."
            sudo chown -R www-data:www-data "$TARGET_DIR"
            sudo chmod -R 755 "$TARGET_DIR"
            echo "âœ… æƒé™è®¾ç½®å®Œæˆ"
            
            # æ›´æ–° Nginx é…ç½®
            NGINX_CONFIG="/etc/nginx/sites-available/50zf.usdt2026.cc"
            if [ ! -f "$NGINX_CONFIG" ]; then
              # å¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°è¯•æŸ¥æ‰¾å…¶ä»–å¯èƒ½çš„é…ç½®æ–‡ä»¶å
              NGINX_CONFIG="/etc/nginx/sites-available/wushizhifu"
            fi
            
            if [ -f "$NGINX_CONFIG" ]; then
              echo "ğŸ”§ æ›´æ–° Nginx é…ç½®..."
              # æ›´æ–° root è·¯å¾„
              sudo sed -i "s|root /.*/frontend/dist;|root $TARGET_DIR;|g" "$NGINX_CONFIG"
              sudo sed -i "s|root /.*/frontend;|root $TARGET_DIR;|g" "$NGINX_CONFIG"
              echo "âœ… Nginx é…ç½®å·²æ›´æ–°"
            else
              echo "âš ï¸  Nginx é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $NGINX_CONFIG"
              echo "   è¯·æ‰‹åŠ¨åˆ›å»ºæˆ–æ£€æŸ¥é…ç½®æ–‡ä»¶ä½ç½®"
            fi
            
            # é‡è½½ Nginx
            echo "ğŸ”„ é‡è½½ Nginx..."
            sudo nginx -t && sudo systemctl reload nginx || {
              echo "âš ï¸  Nginx é‡è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®"
            }
            
            # å¯åŠ¨/é‡å¯ API æœåŠ¡ï¼ˆå®Œæ•´è‡ªåŠ¨åŒ–è¯Šæ–­å’Œä¿®å¤ï¼‰
            echo "ğŸ”„ å¯åŠ¨/é‡å¯ API æœåŠ¡..."
            API_FILE="/home/ubuntu/wushizhifu/api_server.py"
            SERVICE_NAME="wushipay-api"
            PROJECT_ROOT="/home/ubuntu/wushizhifu"
            
            if [ -f "$API_FILE" ]; then
              echo "ğŸ“‹ æ­¥éª¤ 1: æ£€æŸ¥å¹¶åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆå¦‚æœéœ€è¦ï¼‰..."
              if [ ! -d "$PROJECT_ROOT/venv" ]; then
                echo "   åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
                cd "$PROJECT_ROOT"
                python3 -m venv venv || python3 -m virtualenv venv
              fi
              
              echo "ğŸ“‹ æ­¥éª¤ 2: å®‰è£… Python ä¾èµ–..."
              if [ -f "$PROJECT_ROOT/venv/bin/pip" ]; then
                $PROJECT_ROOT/venv/bin/pip install --upgrade pip -q || true
                $PROJECT_ROOT/venv/bin/pip install -q fastapi uvicorn python-multipart httpx requests python-dotenv || true
                if [ -f "$PROJECT_ROOT/requirements.txt" ]; then
                  $PROJECT_ROOT/venv/bin/pip install -q -r "$PROJECT_ROOT/requirements.txt" || true
                fi
              else
                pip3 install --user --upgrade pip -q || true
                pip3 install --user -q fastapi uvicorn python-multipart httpx requests python-dotenv || true
                if [ -f "$PROJECT_ROOT/requirements.txt" ]; then
                  pip3 install --user -q -r "$PROJECT_ROOT/requirements.txt" || true
                fi
              fi
              
              echo "ğŸ“‹ æ­¥éª¤ 3: æ£€æŸ¥å¹¶åˆ›å»º Systemd æœåŠ¡æ–‡ä»¶..."
              if [ ! -f "/etc/systemd/system/${SERVICE_NAME}.service" ]; then
                echo "   æœåŠ¡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæœåŠ¡..."
                
                # ç¡®å®š Python å’Œ uvicorn è·¯å¾„
                if [ -f "$PROJECT_ROOT/venv/bin/uvicorn" ]; then
                  UVICORN_CMD="$PROJECT_ROOT/venv/bin/uvicorn"
                elif [ -f "$PROJECT_ROOT/venv/bin/python3" ]; then
                  UVICORN_CMD="$PROJECT_ROOT/venv/bin/python3 -m uvicorn"
                else
                  UVICORN_CMD="python3 -m uvicorn"
                fi
                
                # å¦‚æœæ¨¡æ¿å­˜åœ¨ï¼Œä½¿ç”¨æ¨¡æ¿ï¼›å¦åˆ™åŠ¨æ€åˆ›å»º
                if [ -f "$PROJECT_ROOT/deploy/systemd/wushipay-api.service" ]; then
                  sudo cp "$PROJECT_ROOT/deploy/systemd/wushipay-api.service" "/etc/systemd/system/${SERVICE_NAME}.service"
                  sudo sed -i "s|/home/ubuntu/wushizhifu|$PROJECT_ROOT|g" "/etc/systemd/system/${SERVICE_NAME}.service"
                else
                  # åŠ¨æ€åˆ›å»ºæœåŠ¡æ–‡ä»¶
                  sudo bash -c "cat > /etc/systemd/system/${SERVICE_NAME}.service <<EOF
[Unit]
Description=WuShiPay API Service (FastAPI)
After=network.target

[Service]
Type=simple
User=ubuntu
Group=ubuntu
WorkingDirectory=$PROJECT_ROOT
Environment=\"PATH=$PROJECT_ROOT/venv/bin:/usr/local/bin:/usr/bin:/bin\"
Environment=\"PYTHONUNBUFFERED=1\"
Environment=\"PYTHONPATH=$PROJECT_ROOT\"
EnvironmentFile=-$PROJECT_ROOT/.env

ExecStart=$UVICORN_CMD api_server:app --host 127.0.0.1 --port 8000

Restart=always
RestartSec=10

StandardOutput=journal
StandardError=journal
SyslogIdentifier=wushipay-api

NoNewPrivileges=true
PrivateTmp=true
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF"
                fi
                sudo systemctl daemon-reload
                echo "âœ… Systemd æœåŠ¡æ–‡ä»¶å·²åˆ›å»º"
              else
                echo "âœ… æœåŠ¡æ–‡ä»¶å·²å­˜åœ¨"
              fi
              
              echo "ğŸ“‹ æ­¥éª¤ 4: åœæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹..."
              if command -v lsof > /dev/null 2>&1; then
                if lsof -i:8000 > /dev/null 2>&1; then
                  echo "   å‘ç°ç«¯å£ 8000 è¢«å ç”¨ï¼Œåœæ­¢è¿›ç¨‹..."
                  sudo kill -9 $(lsof -t -i:8000) 2>/dev/null || true
                  sleep 2
                fi
              else
                # å¦‚æœæ²¡æœ‰ lsofï¼Œä½¿ç”¨ netstat æˆ– ss
                if command -v ss > /dev/null 2>&1; then
                  PID=$(sudo ss -tlnp | grep :8000 | awk '{print $6}' | cut -d',' -f2 | cut -d'=' -f2 | head -1)
                  if [ -n "$PID" ]; then
                    echo "   å‘ç°ç«¯å£ 8000 è¢«å ç”¨ï¼Œåœæ­¢è¿›ç¨‹ $PID..."
                    sudo kill -9 $PID 2>/dev/null || true
                    sleep 2
                  fi
                fi
              fi
              
              echo "ğŸ“‹ æ­¥éª¤ 5: å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡..."
              sudo systemctl enable ${SERVICE_NAME} || true
              sudo systemctl restart ${SERVICE_NAME} || sudo systemctl start ${SERVICE_NAME}
              
              echo "ğŸ“‹ æ­¥éª¤ 6: ç­‰å¾…æœåŠ¡å¯åŠ¨..."
              sleep 3
              
              echo "ğŸ“‹ æ­¥éª¤ 7: éªŒè¯æœåŠ¡çŠ¶æ€..."
              if systemctl is-active --quiet ${SERVICE_NAME}; then
                echo "âœ… API æœåŠ¡å·²æˆåŠŸå¯åŠ¨"
                
                # æµ‹è¯• API ç«¯ç‚¹
                echo "ğŸ“‹ æ­¥éª¤ 8: æµ‹è¯• API ç«¯ç‚¹..."
                sleep 2
                if curl -s http://127.0.0.1:8000/ > /dev/null 2>&1; then
                  echo "âœ… API æœåŠ¡å“åº”æ­£å¸¸"
                else
                  echo "âš ï¸  API æœåŠ¡è¿è¡Œä½†æ— æ³•å“åº”ï¼ŒæŸ¥çœ‹æ—¥å¿—:"
                  sudo journalctl -u ${SERVICE_NAME} -n 20 --no-pager || true
                fi
              else
                echo "âŒ API æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œè¯Šæ–­é—®é¢˜..."
                echo "   æœåŠ¡çŠ¶æ€:"
                sudo systemctl status ${SERVICE_NAME} --no-pager -l | head -30 || true
                echo ""
                echo "   æœ€è¿‘æ—¥å¿—:"
                sudo journalctl -u ${SERVICE_NAME} -n 30 --no-pager || true
                echo ""
                echo "   å°è¯•æ‰‹åŠ¨å¯åŠ¨ä»¥æŸ¥çœ‹è¯¦ç»†é”™è¯¯..."
                cd "$PROJECT_ROOT"
                if [ -f "$PROJECT_ROOT/venv/bin/python3" ]; then
                  $PROJECT_ROOT/venv/bin/python3 -c "import api_server" 2>&1 | head -20 || echo "æ— æ³•å¯¼å…¥ api_server æ¨¡å—"
                fi
              fi
            else
              echo "âš ï¸  API æ–‡ä»¶ä¸å­˜åœ¨: $API_FILE"
              echo "   è·³è¿‡ API æœåŠ¡å¯åŠ¨"
            fi
            
            echo "âœ… éƒ¨ç½²å®Œæˆ"
            echo "ğŸŒ è®¿é—®: https://50zf.usdt2026.cc"

