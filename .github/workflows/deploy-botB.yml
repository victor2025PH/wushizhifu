name: Deploy Bot B

on:
  push:
    branches:
      - main
    paths:
      - 'botB/**'
      - 'services/**'
      - 'database/**'
      - '.github/workflows/deploy-botB.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Deploy to server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
          
          # Create deployment script
          cat > /tmp/deploy_botb.sh << 'DEPLOY_EOF'
          #!/bin/bash
          set -e
          
          echo "=========================================="
          echo "ðŸš€ Bot B è‡ªåŠ¨éƒ¨ç½²"
          echo "=========================================="
          
          cd $SERVER_PATH || exit 1
          echo "ðŸ“ å½“å‰ç›®å½•: $(pwd)"
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          echo "ðŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
          git pull origin main || exit 1
          
          # è¿›å…¥botBç›®å½•
          cd botB || exit 1
          
          # æ¿€æ´»è™šæ‹ŸçŽ¯å¢ƒæˆ–åˆ›å»º
          if [ ! -d "venv" ]; then
            echo "ðŸ“¦ åˆ›å»ºè™šæ‹ŸçŽ¯å¢ƒ..."
            python3 -m venv venv
          fi
          
          source venv/bin/activate
          
          # å®‰è£…ä¾èµ–
          echo "ðŸ“¦ å®‰è£…ä¾èµ–..."
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # é‡å¯æœåŠ¡
          echo "ðŸ”„ é‡å¯æœåŠ¡..."
          sudo systemctl restart otc-bot.service || echo "âš ï¸ æœåŠ¡é‡å¯å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          sleep 2
          if systemctl is-active --quiet otc-bot.service; then
            echo "âœ… æœåŠ¡è¿è¡Œæ­£å¸¸"
          else
            echo "âš ï¸ æœåŠ¡å¯èƒ½æœªæ­£å¸¸è¿è¡Œï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi
          
          echo "=========================================="
          echo "âœ… éƒ¨ç½²å®Œæˆ"
          echo "=========================================="
          DEPLOY_EOF
          
          chmod +x /tmp/deploy_botb.sh
          scp /tmp/deploy_botb.sh $SERVER_USER@$SERVER_HOST:/tmp/deploy_botb.sh
          ssh $SERVER_USER@$SERVER_HOST "bash /tmp/deploy_botb.sh"
