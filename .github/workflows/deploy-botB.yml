name: Deploy Bot B

on:
  push:
    branches:
      - main
    paths:
      - 'botB/**'
      - 'services/**'
      - 'database/**'
      - '.github/workflows/deploy-botb.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          cd botB
          pip install -r requirements.txt
      
      - name: Deploy to server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
          
          # Create deployment script
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          cd $SERVER_PATH
          git pull origin main
          
          cd botB
          source venv/bin/activate || python3 -m venv venv && source venv/bin/activate
          pip install -r requirements.txt
          
          # Restart service
          sudo systemctl restart otc-bot.service || true
          
          echo "Deployment completed successfully"
          EOF
          
          chmod +x deploy.sh
          scp deploy.sh $SERVER_USER@$SERVER_HOST:/tmp/deploy_botb.sh
          ssh $SERVER_USER@$SERVER_HOST "bash /tmp/deploy_botb.sh"
