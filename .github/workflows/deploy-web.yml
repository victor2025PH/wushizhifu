name: Deploy Web Frontend

on:
  push:
    branches:
      - main
    paths:
      - 'web/**'
      - '.github/workflows/deploy-web.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Pull Code
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 300s
          script: |
            SERVER_PATH="${{ secrets.SERVER_PATH || '/home/ubuntu/wushizhifu' }}"
            cd ${SERVER_PATH} || exit 1
            if [ -d ".git" ]; then
              git stash || true
              git pull origin main || echo "⚠️ Git pull失败，继续部署"
            else
              echo "⚠️ 当前目录不是Git仓库，跳过git pull"
            fi
      
      - name: Build and Deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 300s
          script: |
            SERVER_PATH="${{ secrets.SERVER_PATH || '/home/ubuntu/wushizhifu' }}"
            WEB_DIR="${SERVER_PATH}/web"
            WEB_DIST="${WEB_DIR}/dist"
            
            echo "📦 开始构建Web前端..."
            cd ${WEB_DIR} || exit 1
            
            # Check if Node.js is installed
            if ! command -v node &> /dev/null; then
              echo "⚠️ Node.js未安装，开始安装..."
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt install -y nodejs
            fi
            
            # Install dependencies
            echo "📥 安装依赖..."
            npm install --production=false || npm ci || exit 1
            
            # Fix permissions for dist directory before build
            echo "🔧 修复dist目录权限..."
            if [ -d "dist" ]; then
              # Change ownership to current user before removing
              sudo chown -R ${USER}:${USER} dist 2>/dev/null || true
              rm -rf dist || sudo rm -rf dist || true
            fi
            mkdir -p dist
            chmod -R 755 dist || true
            
            # Build project (output will be in web/dist)
            echo "🔨 构建项目..."
            npm run build || {
              echo "❌ 构建失败，查看详细错误："
              npm run build 2>&1 | tail -50
              exit 1
            }
            
            # Check if dist directory was created
            if [ ! -d "dist" ]; then
              echo "❌ 构建失败: dist目录不存在"
              exit 1
            fi
            
            # 验证构建结果
            echo "🔍 验证构建结果..."
            FILE_COUNT=$(find dist -type f 2>/dev/null | wc -l)
            echo "  构建文件数量: $FILE_COUNT"
            
            if [ "$FILE_COUNT" -lt 5 ]; then
              echo "⚠️ 警告: 构建文件数量过少 ($FILE_COUNT)，可能构建不完整"
              echo "  检查dist目录内容:"
              ls -la dist/ | head -20
            fi
            
            # 检查关键文件
            if [ ! -f "dist/index.html" ]; then
              echo "❌ 构建失败: dist/index.html 不存在"
              exit 1
            fi
            echo "✅ 构建验证通过"
            
            # Set proper permissions for dist directory
            echo "🔒 设置文件权限..."
            sudo chown -R www-data:www-data dist || true
            sudo chmod -R 755 dist || true
            
            # Update Nginx configuration for web domain
            NGINX_CONFIG="/etc/nginx/sites-available/web-5050"
            DOMAIN="5050.usdt2026.cc"
            
            echo "⚙️ 配置Nginx站点..."
            # 直接使用fix_5050_complete.sh脚本来配置Nginx（最可靠的方法）
            if [ -f "${SERVER_PATH}/deploy/fix_5050_complete.sh" ]; then
              echo "📋 使用fix_5050_complete.sh脚本配置Nginx..."
              chmod +x "${SERVER_PATH}/deploy/fix_5050_complete.sh"
              # 只执行Nginx配置部分，跳过构建（因为已经构建完成）
              # 但脚本会自动检测dist目录，如果存在就跳过构建
              "${SERVER_PATH}/deploy/fix_5050_complete.sh" || {
                echo "⚠️ 修复脚本执行完成（可能有警告），继续部署流程..."
              }
            else
              echo "⚠️ fix_5050_complete.sh脚本不存在，使用模板文件..."
              if [ -f "${SERVER_PATH}/deploy/nginx-web.conf" ]; then
                echo "📋 使用nginx-web.conf模板..."
                sudo cp "${SERVER_PATH}/deploy/nginx-web.conf" ${NGINX_CONFIG}
                # 替换占位符
                sudo sed -i "s|DOMAIN_PLACEHOLDER|${DOMAIN}|g" ${NGINX_CONFIG}
                sudo sed -i "s|WEB_DIST_PLACEHOLDER|${WEB_DIST}|g" ${NGINX_CONFIG}
                
                # 检查SSL证书并启用HTTPS
                if [ -f "/etc/letsencrypt/live/${DOMAIN}/fullchain.pem" ] && [ -f "/etc/letsencrypt/live/${DOMAIN}/privkey.pem" ]; then
                  echo "🔐 SSL证书存在，启用HTTPS配置..."
                  # 取消注释HTTPS_START和HTTPS_END之间的所有行
                  sudo sed -i '/#HTTPS_START/,/#HTTPS_END/s/^#//' ${NGINX_CONFIG}
                  # 删除HTTPS_START和HTTPS_END标记行
                  sudo sed -i '/#HTTPS_START/d; /#HTTPS_END/d' ${NGINX_CONFIG}
                  # 启用HTTP到HTTPS重定向
                  sudo sed -i 's|# return 301 https://$server_name$request_uri;|return 301 https://$server_name$request_uri;|g' ${NGINX_CONFIG}
                else
                  echo "ℹ️ SSL证书不存在，保持HTTPS配置为注释状态"
                  # 注释掉HTTPS_START和HTTPS_END标记行之间的内容
                  sudo sed -i '/#HTTPS_START/,/#HTTPS_END/s/^[^#]/#&/' ${NGINX_CONFIG}
                fi
              else
                echo "❌ 模板文件和修复脚本都不存在，无法配置Nginx"
                exit 1
              fi
              
              # 启用站点
              sudo ln -sf ${NGINX_CONFIG} /etc/nginx/sites-enabled/web-5050
              
              # 测试并重载Nginx（使用模板的情况）
              echo "🔄 测试并重载Nginx..."
              sudo nginx -t && sudo systemctl reload nginx || echo "⚠️ Nginx重载失败"
            fi
            
            # 验证配置（无论是使用脚本还是模板，都需要验证）
            echo "🔍 验证Nginx配置..."
            echo "检查5050.usdt2026.cc的root配置:"
            ROOT_5050=$(sudo nginx -T 2>/dev/null | grep -A 10 "server_name 5050.usdt2026.cc" | grep "root" | head -1 | awk '{print $2}' | sed 's/;//')
            echo "  当前root: $ROOT_5050"
            echo "  期望root: ${WEB_DIST}"
            
            if [ "$ROOT_5050" = "${WEB_DIST}" ]; then
              echo "✅ 5050配置正确"
            else
              echo "❌ 5050配置错误！正在修复..."
              # 如果使用脚本但配置仍然错误，再次运行脚本
              if [ -f "${SERVER_PATH}/deploy/fix_5050_complete.sh" ]; then
                echo "🔧 再次运行修复脚本..."
                chmod +x "${SERVER_PATH}/deploy/fix_5050_complete.sh"
                "${SERVER_PATH}/deploy/fix_5050_complete.sh" || echo "⚠️ 修复脚本执行完成（可能有警告）"
              else
                # 使用sed直接修复
                sudo sed -i "s|root .*;|root ${WEB_DIST};|g" ${NGINX_CONFIG}
                sudo nginx -t && sudo systemctl reload nginx
                echo "✅ 已修复5050配置"
              fi
            fi
            
            # 检查50zf配置（确保不会冲突）
            echo "检查50zf.usdt2026.cc的root配置:"
            ROOT_50ZF=$(sudo nginx -T 2>/dev/null | grep -A 10 "server_name 50zf.usdt2026.cc" | grep "root" | head -1 | awk '{print $2}' | sed 's/;//')
            if [ -n "$ROOT_50ZF" ]; then
              echo "  当前root: $ROOT_50ZF"
              EXPECTED_50ZF="/home/ubuntu/wushizhifu/wushizhifu-full/dist"
              if [ "$ROOT_50ZF" = "$EXPECTED_50ZF" ]; then
                echo "✅ 50zf配置正确"
              else
                echo "⚠️ 50zf配置可能不正确，但不会影响5050"
              fi
            fi
            
            # 运行完整修复脚本（如果存在且配置错误）
            if [ "$ROOT_5050" != "${WEB_DIST}" ]; then
              if [ -f "${SERVER_PATH}/deploy/fix_5050_complete.sh" ]; then
                echo "🔍 检测到5050配置错误，运行完整修复脚本..."
                chmod +x "${SERVER_PATH}/deploy/fix_5050_complete.sh"
                "${SERVER_PATH}/deploy/fix_5050_complete.sh" || echo "⚠️ 修复脚本执行完成（可能有警告）"
              elif [ -f "${SERVER_PATH}/deploy/diagnose_and_fix_5050.sh" ]; then
                echo "🔍 运行诊断脚本..."
                chmod +x "${SERVER_PATH}/deploy/diagnose_and_fix_5050.sh"
                "${SERVER_PATH}/deploy/diagnose_and_fix_5050.sh" || echo "⚠️ 诊断脚本执行完成（可能有警告）"
              fi
            fi
            
            # 最终验证：检查Nginx是否运行
            echo ""
            echo "🔍 最终验证..."
            if systemctl is-active --quiet nginx; then
              echo "✅ Nginx服务运行正常"
            else
              echo "❌ Nginx服务未运行！"
              sudo systemctl start nginx || echo "⚠️ 无法启动Nginx"
            fi
            
            # 检查端口监听
            if sudo ss -tlnp 2>/dev/null | grep -q ":80 "; then
              echo "✅ 端口80正在监听"
            else
              echo "⚠️ 端口80未监听，这可能导致连接被拒绝"
            fi
            
            echo "✅ Web前端部署完成"
