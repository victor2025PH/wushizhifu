name: Deploy Web Frontend

on:
  push:
    branches:
      - main
    paths:
      - 'web/**'
      - '.github/workflows/deploy-web.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Pull Code
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 300s
          script: |
            SERVER_PATH="${{ secrets.SERVER_PATH || '/home/ubuntu/wushizhifu' }}"
            cd ${SERVER_PATH} || exit 1
            if [ -d ".git" ]; then
              git stash || true
              git pull origin main || echo "âš ï¸ Git pullå¤±è´¥ï¼Œç»§ç»­éƒ¨ç½²"
            else
              echo "âš ï¸ å½“å‰ç›®å½•ä¸æ˜¯Gitä»“åº“ï¼Œè·³è¿‡git pull"
            fi
      
      - name: Build and Deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 300s
          script: |
            SERVER_PATH="${{ secrets.SERVER_PATH || '/home/ubuntu/wushizhifu' }}"
            WEB_DIR="${SERVER_PATH}/web"
            WEB_DIST="${WEB_DIR}/dist"
            
            echo "ğŸ“¦ å¼€å§‹æ„å»ºWebå‰ç«¯..."
            cd ${WEB_DIR} || exit 1
            
            # Check if Node.js is installed
            if ! command -v node &> /dev/null; then
              echo "âš ï¸ Node.jsæœªå®‰è£…ï¼Œå¼€å§‹å®‰è£…..."
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt install -y nodejs
            fi
            
            # Install dependencies
            echo "ğŸ“¥ å®‰è£…ä¾èµ–..."
            npm install --production=false || npm ci || exit 1
            
            # Build project (output will be in web/dist)
            echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
            npm run build || exit 1
            
            # Check if dist directory was created
            if [ ! -d "dist" ]; then
              echo "âŒ æ„å»ºå¤±è´¥: distç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
            
            # Set proper permissions for dist directory
            echo "ğŸ”’ è®¾ç½®æ–‡ä»¶æƒé™..."
            sudo chown -R www-data:www-data dist || true
            sudo chmod -R 755 dist || true
            
            # Update Nginx configuration if needed
            NGINX_CONFIG="/etc/nginx/sites-available/wushizhifu"
            if [ -f "${NGINX_CONFIG}" ]; then
              # Update root path if different (build output is in web/dist)
              CURRENT_ROOT=$(grep -E "^\s*root\s+" ${NGINX_CONFIG} | head -1 | awk '{print $2}' | sed 's/;//')
              if [ "$CURRENT_ROOT" != "${WEB_DIST}" ]; then
                echo "âš™ï¸ æ›´æ–°Nginxé…ç½®ï¼Œä» $CURRENT_ROOT åˆ° ${WEB_DIST}..."
                sudo sed -i "s|root .*;|root ${WEB_DIST};|g" ${NGINX_CONFIG}
                # Test configuration
                if sudo nginx -t; then
                  echo "âœ… Nginxé…ç½®æ›´æ–°æˆåŠŸ"
                else
                  echo "âš ï¸ Nginxé…ç½®æµ‹è¯•å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
                fi
              else
                echo "âœ… Nginxé…ç½®å·²æ­£ç¡®æŒ‡å‘ ${WEB_DIST}"
              fi
            else
              echo "âš ï¸ Nginxé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€è¦æ‰‹åŠ¨é…ç½®æŒ‡å‘ ${WEB_DIST}"
            fi
            
            # Reload Nginx
            echo "ğŸ”„ é‡è½½Nginx..."
            sudo nginx -t && sudo systemctl reload nginx || echo "âš ï¸ Nginxé‡è½½å¤±è´¥"
            
            echo "âœ… Webå‰ç«¯éƒ¨ç½²å®Œæˆ"
