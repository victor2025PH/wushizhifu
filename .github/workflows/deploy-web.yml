name: Deploy Web Frontend

on:
  push:
    branches:
      - main
    paths:
      - 'web/**'
      - '.github/workflows/deploy-web.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Pull Code
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 300s
          script: |
            SERVER_PATH="${{ secrets.SERVER_PATH || '/home/ubuntu/wushizhifu' }}"
            cd ${SERVER_PATH} || exit 1
            if [ -d ".git" ]; then
              git stash || true
              git pull origin main || echo "âš ï¸ Git pullå¤±è´¥ï¼Œç»§ç»­éƒ¨ç½²"
            else
              echo "âš ï¸ å½“å‰ç›®å½•ä¸æ˜¯Gitä»“åº“ï¼Œè·³è¿‡git pull"
            fi
      
      - name: Build and Deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 300s
          script: |
            SERVER_PATH="${{ secrets.SERVER_PATH || '/home/ubuntu/wushizhifu' }}"
            WEB_DIR="${SERVER_PATH}/web"
            WEB_DIST="${WEB_DIR}/dist"
            
            echo "ğŸ“¦ å¼€å§‹æ„å»ºWebå‰ç«¯..."
            cd ${WEB_DIR} || exit 1
            
            # Check if Node.js is installed
            if ! command -v node &> /dev/null; then
              echo "âš ï¸ Node.jsæœªå®‰è£…ï¼Œå¼€å§‹å®‰è£…..."
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt install -y nodejs
            fi
            
            # Install dependencies
            echo "ğŸ“¥ å®‰è£…ä¾èµ–..."
            npm install --production=false || npm ci || exit 1
            
            # Fix permissions for dist directory before build
            echo "ğŸ”§ ä¿®å¤distç›®å½•æƒé™..."
            if [ -d "dist" ]; then
              # Change ownership to current user before removing
              sudo chown -R ${USER}:${USER} dist 2>/dev/null || true
              rm -rf dist || sudo rm -rf dist || true
            fi
            mkdir -p dist
            chmod -R 755 dist || true
            
            # Build project (output will be in web/dist)
            echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
            npm run build || exit 1
            
            # Check if dist directory was created
            if [ ! -d "dist" ]; then
              echo "âŒ æ„å»ºå¤±è´¥: distç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
            
            # Set proper permissions for dist directory
            echo "ğŸ”’ è®¾ç½®æ–‡ä»¶æƒé™..."
            sudo chown -R www-data:www-data dist || true
            sudo chmod -R 755 dist || true
            
            # Update Nginx configuration for web domain
            NGINX_CONFIG="/etc/nginx/sites-available/web-5050"
            DOMAIN="5050.usdt2026.cc"
            
            echo "âš™ï¸ é…ç½®Nginxç«™ç‚¹..."
            # Create Nginx configuration file using template file
            if [ -f "${SERVER_PATH}/deploy/nginx-web.conf" ]; then
              echo "ğŸ“‹ ä½¿ç”¨éƒ¨ç½²ç›®å½•ä¸­çš„nginx-web.confæ¨¡æ¿..."
              sudo cp "${SERVER_PATH}/deploy/nginx-web.conf" ${NGINX_CONFIG}
              sudo sed -i "s|5050.usdt2026.cc|${DOMAIN}|g" ${NGINX_CONFIG}
              sudo sed -i "s|/home/ubuntu/wushizhifu/web/dist|${WEB_DIST}|g" ${NGINX_CONFIG}
            else
              echo "âš ï¸ æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨echoå‘½ä»¤åˆ›å»ºé…ç½®..."
              sudo sh -c "echo '# Nginx é…ç½®æ–‡ä»¶ - Webå‰ç«¯ç½‘ç«™' > ${NGINX_CONFIG}"
              sudo sh -c "echo '# åŸŸå: ${DOMAIN}' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '' >> ${NGINX_CONFIG}"
              sudo sh -c "echo 'server {' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '    listen 80;' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '    server_name ${DOMAIN};' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '    return 301 https://\\\$server_name\\\$request_uri;' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '}' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '' >> ${NGINX_CONFIG}"
              # Only add HTTPS block if SSL certificate exists
              if [ "$HAS_SSL" = true ]; then
                sudo sh -c "echo 'server {' >> ${NGINX_CONFIG}"
                sudo sh -c "echo '    listen 443 ssl http2;' >> ${NGINX_CONFIG}"
                sudo sh -c "echo '    server_name ${DOMAIN};' >> ${NGINX_CONFIG}"
                sudo sh -c "echo '    ssl_certificate /etc/letsencrypt/live/${DOMAIN}/fullchain.pem;' >> ${NGINX_CONFIG}"
                sudo sh -c "echo '    ssl_certificate_key /etc/letsencrypt/live/${DOMAIN}/privkey.pem;' >> ${NGINX_CONFIG}"
              else
                sudo sh -c "echo '# HTTPS server block disabled - SSL certificate not found' >> ${NGINX_CONFIG}"
                sudo sh -c "echo '# Run: sudo certbot --nginx -d ${DOMAIN}' >> ${NGINX_CONFIG}"
              fi
              sudo sh -c "echo '    ssl_protocols TLSv1.2 TLSv1.3;' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '    ssl_ciphers HIGH:!aNULL:!MD5;' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '    ssl_prefer_server_ciphers on;' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '    root ${WEB_DIST};' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '    index index.html;' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '    location / {' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '        try_files \\\$uri \\\$uri/ /index.html;' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '    }' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '    location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '        expires 1y;' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '        add_header Cache-Control \"public, immutable\";' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '    }' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '    gzip on;' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '    gzip_vary on;' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '    gzip_min_length 1024;' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;' >> ${NGINX_CONFIG}"
              sudo sh -c "echo '}' >> ${NGINX_CONFIG}"
            fi
            
            # Enable site
            sudo ln -sf ${NGINX_CONFIG} /etc/nginx/sites-enabled/
            
            # Check if SSL certificate exists
            if [ -f "/etc/letsencrypt/live/${DOMAIN}/fullchain.pem" ]; then
              echo "âœ… SSLè¯ä¹¦å·²å­˜åœ¨ï¼Œå¯ç”¨HTTPSé…ç½®..."
              sudo sed -i "s|# ssl_certificate|ssl_certificate|g" ${NGINX_CONFIG}
              sudo sed -i "s|# ssl_certificate_key|ssl_certificate_key|g" ${NGINX_CONFIG}
            else
              echo "âš ï¸ SSLè¯ä¹¦ä¸å­˜åœ¨ï¼Œå…ˆä½¿ç”¨HTTPé…ç½®"
              echo "ğŸ’¡ è¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ç”³è¯·SSLè¯ä¹¦ï¼š"
              echo "   sudo certbot --nginx -d ${DOMAIN}"
            fi
            
            # Reload Nginx
            echo "ğŸ”„ é‡è½½Nginx..."
            sudo nginx -t && sudo systemctl reload nginx || echo "âš ï¸ Nginxé‡è½½å¤±è´¥"
            
            # éªŒè¯é…ç½®
            echo "ğŸ” éªŒè¯Nginxé…ç½®..."
            echo "æ£€æŸ¥5050.usdt2026.ccçš„rooté…ç½®:"
            ROOT_5050=$(sudo nginx -T 2>/dev/null | grep -A 10 "server_name 5050.usdt2026.cc" | grep "root" | head -1 | awk '{print $2}' | sed 's/;//')
            echo "  å½“å‰root: $ROOT_5050"
            echo "  æœŸæœ›root: ${WEB_DIST}"
            
            if [ "$ROOT_5050" = "${WEB_DIST}" ]; then
              echo "âœ… 5050é…ç½®æ­£ç¡®"
            else
              echo "âŒ 5050é…ç½®é”™è¯¯ï¼æ­£åœ¨ä¿®å¤..."
              sudo sed -i "s|root .*;|root ${WEB_DIST};|g" ${NGINX_CONFIG}
              sudo nginx -t && sudo systemctl reload nginx
              echo "âœ… å·²ä¿®å¤5050é…ç½®"
            fi
            
            # æ£€æŸ¥50zfé…ç½®ï¼ˆç¡®ä¿ä¸ä¼šå†²çªï¼‰
            echo "æ£€æŸ¥50zf.usdt2026.ccçš„rooté…ç½®:"
            ROOT_50ZF=$(sudo nginx -T 2>/dev/null | grep -A 10 "server_name 50zf.usdt2026.cc" | grep "root" | head -1 | awk '{print $2}' | sed 's/;//')
            if [ -n "$ROOT_50ZF" ]; then
              echo "  å½“å‰root: $ROOT_50ZF"
              EXPECTED_50ZF="/home/ubuntu/wushizhifu/wushizhifu-full/dist"
              if [ "$ROOT_50ZF" = "$EXPECTED_50ZF" ]; then
                echo "âœ… 50zfé…ç½®æ­£ç¡®"
              else
                echo "âš ï¸ 50zfé…ç½®å¯èƒ½ä¸æ­£ç¡®ï¼Œä½†ä¸ä¼šå½±å“5050"
              fi
            fi
            
            echo "âœ… Webå‰ç«¯éƒ¨ç½²å®Œæˆ"
