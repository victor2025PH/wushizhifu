# Bot A 视频自动配置使用指南

## 📋 功能说明

Bot A 已经实现了**自动视频配置功能**。当您在指定的 Telegram 频道上传视频后，Bot 会自动检测并询问管理员将视频设置为"微信视频"还是"支付宝视频"。

## 🎯 使用步骤

### 1. 确认频道 ID

Bot 监听以下频道：
- **频道 ID**: `-1003390475622`

### 2. 确保 Bot A 已添加到频道

Bot A 需要：
- ✅ 作为**管理员**添加到该频道
- ✅ 具有**查看消息**权限

**检查方法**：
1. 打开频道设置
2. 查看管理员列表，确认 Bot A 在列表中
3. 确保 Bot 有权限读取频道消息

### 3. 上传视频到频道

在频道中上传视频：
1. 打开指定的 Telegram 频道
2. 直接上传视频文件（支持 Telegram 支持的所有视频格式）
3. Bot A 会自动检测视频

### 4. 选择视频类型

视频上传后：
1. ✅ Bot A 会向**所有管理员**发送询问消息
2. ✅ 消息包含：
   - 视频信息（消息 ID、文件大小、时长）
   - 两个按钮："微信视频" 和 "支付宝视频"
   - 一个"取消"按钮

3. **管理员操作**：
   - 点击 **"微信视频"** → 视频将配置为微信支付教程视频
   - 点击 **"支付宝视频"** → 视频将配置为支付宝支付教程视频
   - 点击 **"取消"** → 取消配置

### 5. 配置完成

配置成功后：
- ✅ 视频信息会保存到数据库
- ✅ MiniApp 的 `/api/videos/alipay` 和 `/api/videos/wechat` 端点将返回视频 URL
- ✅ 前端页面可以正常播放视频

## 🔍 验证配置

### 方法 1: 通过 API 测试

```bash
# 测试支付宝视频
curl http://127.0.0.1:8000/api/videos/alipay

# 测试微信视频
curl http://127.0.0.1:8000/api/videos/wechat
```

**预期结果**：
- ✅ 如果已配置：返回 JSON，包含 `url`、`file_id` 等字段
- ❌ 如果未配置：返回 `{"detail": "Alipay video not configured"}`

### 方法 2: 通过前端测试

1. 访问 MiniApp：`https://50zf.usdt2026.cc`
2. 点击"支付宝"或"微信"支付选项
3. 点击"观看视频教程"按钮
4. 检查视频是否能正常播放

## ⚙️ 技术细节

### 数据库存储

视频配置保存在 `video_configs` 表中，包含以下字段：
- `video_type`: 'wechat' 或 'alipay'
- `channel_id`: 频道 ID
- `message_id`: 消息 ID
- `file_id`: Telegram 文件 ID
- `file_size`: 文件大小
- `duration`: 视频时长
- `updated_at`: 更新时间

### API 端点

- **GET** `/api/videos/alipay` - 获取支付宝视频 URL
- **GET** `/api/videos/wechat` - 获取微信视频 URL

API 会：
1. 从数据库读取视频配置（`file_id`）
2. 调用 Telegram Bot API 的 `getFile` 方法
3. 返回可下载的视频 URL

## ❗ 常见问题

### Q1: Bot 没有检测到视频？

**检查项**：
1. ✅ Bot A 是否正在运行？
2. ✅ Bot 是否已添加到频道？
3. ✅ Bot 是否有查看消息的权限？
4. ✅ 频道 ID 是否正确（`-1003390475622`）？
5. ✅ 上传的是视频文件（不是图片或其他格式）？

**查看日志**：
```bash
# 查看 Bot A 日志
sudo journalctl -u wushizhifu-bot -f
```

### Q2: 管理员没有收到询问消息？

**检查项**：
1. ✅ 管理员是否在数据库的 `admins` 表中？
2. ✅ 管理员是否已启动 Bot A？
3. ✅ 查看 Bot A 日志是否有错误

### Q3: 视频配置后 API 仍返回 404？

**检查项**：
1. ✅ 数据库是否在同一位置？（Bot A 和 API 服务器应该使用同一个数据库）
2. ✅ API 服务器是否已重启？
3. ✅ 数据库表是否正确创建？

**手动检查数据库**：
```bash
cd /home/ubuntu/wushizhifu
source venv/bin/activate
python3 -c "
from database.video_repository import VideoRepository
configs = VideoRepository.get_all_video_configs()
print('视频配置：')
for config in configs:
    print(f\"  {config['video_type']}: message_id={config['message_id']}\")
"
```

### Q4: 如何更新视频？

只需要在频道中上传新的视频，然后选择相同的类型（微信/支付宝），Bot 会自动更新配置。

### Q5: 如何删除视频配置？

当前版本不支持通过 Bot 删除。如需删除，可以：
1. 直接在数据库中删除记录
2. 上传新视频覆盖配置

## 📝 管理员操作示例

1. **上传支付宝教程视频**：
   - 在频道上传视频
   - 收到 Bot 询问消息
   - 点击"支付宝视频"
   - 看到"✅ 支付宝视频配置已更新！"

2. **上传微信教程视频**：
   - 在频道上传视频
   - 收到 Bot 询问消息
   - 点击"微信视频"
   - 看到"✅ 微信视频配置已更新！"

## ✅ 配置成功标志

- ✅ Bot 发送了询问消息给管理员
- ✅ 点击按钮后显示"配置已更新"
- ✅ API 测试返回视频 URL（不是 404）
- ✅ 前端可以正常播放视频

## 🎬 完整流程演示

```
1. 管理员在频道上传视频
   ↓
2. Bot A 检测到视频
   ↓
3. Bot A 向所有管理员发送询问消息（带按钮）
   ↓
4. 管理员点击"微信视频"或"支付宝视频"
   ↓
5. Bot A 保存配置到数据库
   ↓
6. MiniApp 通过 API 获取视频 URL
   ↓
7. 用户在前端观看视频教程
```

---

**提示**：确保 Bot A 正在运行，否则无法检测频道视频！

