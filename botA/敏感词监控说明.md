# Bot A 敏感词监控说明

## 📋 监控机制概述

Bot A 会在群组中监控所有用户消息，检查是否包含敏感词。如果包含，会根据设置的**动作**（action）进行处理。

## 🔍 监控流程

### 1. 消息处理流程

```
用户发送消息
    ↓
跳过 Bot 和命令（以 / 开头的消息）
    ↓
检查用户是否已验证
    ↓
如果未验证 → 删除消息（验证流程）
    ↓
如果已验证 → 检查敏感词
    ↓
如果包含敏感词 → 根据动作处理
```

### 2. 敏感词检查

Bot A 会检查消息中是否**包含**（使用 `in` 操作符）任何敏感词。

⚠️ **注意**：这是**子串匹配**，不是完整单词匹配！

例如：
- 敏感词设置为 `"广告"`
- 消息 `"这是一个广告测试"` → 会被匹配
- 消息 `"推广广告内容"` → 会被匹配
- 消息 `"欢迎新朋友"` → 不会被匹配

## 🎯 敏感词动作类型

### 1. **warn（警告）** - 默认动作
- 动作：发送警告消息
- 示例：`⚠️ 請注意，消息包含敏感詞：xxx`

### 2. **delete（删除）**
- 动作：删除包含敏感词的消息
- 示例：`⚠️ 消息包含敏感詞：xxx，已自動刪除`

### 3. **ban（封禁）**
- 动作：删除消息 + 封禁用户
- 示例：`🚫 用戶因使用敏感詞 xxx 已被封禁`

## 📝 查看当前敏感词列表

### 方法一：通过管理面板

1. 发送 `/admin` 给 Bot A
2. 点击 "🚫 敏感词管理"
3. 查看敏感词列表

### 方法二：通过命令

发送 `/addword` 查看帮助（需要先有敏感词）

### 方法三：查询数据库

```sql
-- 查看所有敏感词
SELECT word_id, word, action, group_id, is_active 
FROM sensitive_words 
WHERE is_active = 1;

-- 查看全局敏感词（适用于所有群组）
SELECT * FROM sensitive_words 
WHERE group_id IS NULL AND is_active = 1;

-- 查看特定群组的敏感词
SELECT * FROM sensitive_words 
WHERE group_id = -1001234567890 AND is_active = 1;
```

## ⚠️ 可能导致"删除所有消息"的原因

### 原因 1：验证流程
**最可能的原因！**

如果群组开启了**验证功能**，所有未验证用户的消息都会被删除：

```python
# 代码位置：botA/handlers/group_handlers.py
if not GroupRepository.is_member_verified(group_id, user_id):
    # 删除消息
    await message.delete()
```

**解决方案：**
1. 检查群组是否开启了验证功能
2. 确保用户完成验证
3. 或者关闭验证功能

### 原因 2：敏感词过于宽泛

如果敏感词设置得太短或太常见，可能会误匹配：

**示例：**
- 敏感词：`"的"` → 几乎每条中文消息都会被匹配
- 敏感词：`"a"` → 所有包含字母 a 的消息都会被匹配
- 敏感词：`" "` → 所有包含空格的消息都会被匹配

**解决方案：**
1. 检查敏感词列表，删除过于宽泛的词
2. 使用更具体的敏感词（完整词汇或短语）

### 原因 3：敏感词动作设置为 "delete" 或 "ban"

如果敏感词的动作设置为 `delete` 或 `ban`，所有包含该词的消息都会被删除。

**解决方案：**
1. 查看敏感词列表及其动作
2. 将误删的敏感词动作改为 `warn` 或删除该敏感词

## 🛠️ 管理敏感词

### 添加敏感词

**命令格式：**
```
/addword <词语> [动作]
```

**动作选项：**
- `warn` - 警告（默认）
- `delete` - 删除消息
- `ban` - 封禁用户

**示例：**
```
/addword 广告 delete
/addword 刷屏 warn
/addword 恶意 ban
```

### 删除敏感词

**通过管理面板：**
1. `/admin` → "🚫 敏感词管理"
2. 查看列表（注意 word_id）
3. 使用命令删除（需要知道 word_id）

**通过数据库：**
```sql
-- 禁用敏感词（不会真正删除，只是标记为不活跃）
UPDATE sensitive_words 
SET is_active = 0 
WHERE word_id = ?;
```

### 修改敏感词动作

**方法：**
1. 删除旧的敏感词
2. 重新添加，指定新动作

或直接修改数据库：
```sql
UPDATE sensitive_words 
SET action = 'warn'  -- 或 'delete' 或 'ban'
WHERE word_id = ?;
```

## 🔍 诊断步骤

如果发现 Bot A 删除所有消息，按以下步骤诊断：

### 步骤 1：检查验证功能

```sql
-- 查看群组设置
SELECT group_id, verification_enabled 
FROM groups 
WHERE verification_enabled = 1;
```

### 步骤 2：检查敏感词列表

```sql
-- 查看所有活跃的敏感词
SELECT word_id, word, action, group_id 
FROM sensitive_words 
WHERE is_active = 1;
```

**重点检查：**
- 是否有非常短的敏感词（1-2 个字符）
- 是否有常见的字词（如 "的"、"是"、"a"、"的"）
- 是否有动作设置为 `delete` 或 `ban` 的敏感词

### 步骤 3：检查日志

查看 Bot A 日志，找出删除消息的原因：

```bash
# 在服务器上查看日志
sudo journalctl -u wushizhifu-bot.service -f | grep -i "delete\|sensitive\|verification"
```

### 步骤 4：测试消息

发送一条测试消息，观察：
1. 是否被删除
2. Bot 的回复内容
3. 日志中的记录

## 🚨 紧急处理

如果 Bot A 正在删除所有消息：

### 方案 1：临时禁用敏感词过滤

**方法：** 将所有敏感词标记为不活跃

```sql
UPDATE sensitive_words 
SET is_active = 0;
```

### 方案 2：关闭验证功能

```sql
UPDATE groups 
SET verification_enabled = 0;
```

### 方案 3：删除所有敏感词

```sql
UPDATE sensitive_words 
SET is_active = 0 
WHERE is_active = 1;
```

### 方案 4：重启 Bot（如果代码有缓存）

```bash
sudo systemctl restart wushizhifu-bot.service
```

## 📊 最佳实践

### 1. 敏感词设置原则

✅ **推荐：**
- 使用完整词汇或短语（如 "刷屏广告"）
- 使用特定术语（如 "代刷"、"刷单"）
- 动作优先使用 `warn`，谨慎使用 `delete` 和 `ban`

❌ **不推荐：**
- 使用单个字符（如 "的"、"a"）
- 使用常见词汇（如 "好"、"是"、"的"）
- 使用标点符号或空格

### 2. 测试敏感词

添加敏感词前，先测试：
1. 添加敏感词时使用 `warn` 动作
2. 观察几天，确认匹配准确
3. 如果准确，再考虑改为 `delete` 或 `ban`

### 3. 定期审查

定期检查敏感词列表：
- 删除不再需要的敏感词
- 修改误匹配的敏感词
- 调整动作类型

## 📞 获取帮助

如果问题仍未解决：

1. **查看日志**：`sudo journalctl -u wushizhifu-bot.service -n 100`
2. **检查数据库**：查询敏感词和群组设置
3. **联系管理员**：提供日志和数据库查询结果

